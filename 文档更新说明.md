# 文档更新说明

**更新日期**：2024-12-19  
**更新原因**：补充AI推荐方案一键预订的预订单单号规则

---

## 📝 更新内容

### 关键更新点
根据设计思路文档，补充了以下关键信息：
- **AI推荐方案一键预订生成的预订单单号规则**：`BK+AI+年月日时分秒+五位顺序号`

### 更新前的问题
- 原文档中只说明了经典预订的订单号规则（BK+TR+...）
- 缺少AI推荐方案一键预订的订单号规则（BK+AI+...）
- 数据库函数只支持生成BK+TR订单号

---

## 📄 已更新的文档

### 1. YQFAIBTRIP需求文档.md

#### 更新位置1：单号生成规则汇总表（第3章）
**更新前**：
- 只有"经典预订订单"一行

**更新后**：
- 添加了"AI推荐方案一键预订订单"一行
- 单号规则：`BK+AI+年月日时分秒+五位顺序号`
- 示例：`BK+AI+20241219143025+00001`

#### 更新位置2：经典预订业务规则（2.3.1节）
**更新前**：
```
- **预订单号规则**：`BK+TR+年月日时分秒+五位顺序号`
```

**更新后**：
```
- **预订单号规则**：
  - 经典预订订单：`BK+TR+年月日时分秒+五位顺序号`
  - AI推荐方案一键预订订单：`BK+AI+年月日时分秒+五位顺序号`
```

#### 更新位置3：AI推荐方案详情页（2.4.3节）
**已包含**：
- 一键预订功能说明中已包含订单号规则

---

### 2. 数据库设计文档.md

#### 更新位置1：orders表字段说明（2.3.1节）
**更新前**：
```
| order_no | VARCHAR(50) | UNIQUE, NOT NULL | 订单号（BK+TR+...） |
```

**更新后**：
```
| order_no | VARCHAR(50) | UNIQUE, NOT NULL | 订单号（BK+TR+... 或 BK+AI+...） |
```

#### 更新位置2：booking_source字段说明（2.3.1节）
**更新前**：
```
| booking_source | VARCHAR(50) | DEFAULT 'classic' | 预订来源（classic/ai_recommendation） |
```

**更新后**：
```
| booking_source | VARCHAR(50) | DEFAULT 'classic' | 预订来源（classic=经典预订生成BK+TR订单号，ai_recommendation=AI推荐一键预订生成BK+AI订单号） |
```

#### 更新位置3：generate_order_no函数（3.1节）
**更新前**：
```sql
CREATE OR REPLACE FUNCTION generate_order_no() RETURNS VARCHAR AS $$
-- 固定生成 BK+TR 订单号
```

**更新后**：
```sql
CREATE OR REPLACE FUNCTION generate_order_no(
    booking_source VARCHAR DEFAULT 'classic' -- 'classic' 或 'ai_recommendation'
) RETURNS VARCHAR AS $$
-- 根据 booking_source 参数生成对应的订单号：
-- 'classic' → BK+TR+...
-- 'ai_recommendation' → BK+AI+...
```

**函数逻辑**：
- 如果 `booking_source = 'ai_recommendation'`，生成 `BK+AI+年月日时分秒+五位顺序号`
- 否则（默认），生成 `BK+TR+年月日时分秒+五位顺序号`

---

### 3. 项目文档总览.md

#### 更新位置：单号生成规则表
**更新前**：
- 只有7种业务类型的单号规则

**更新后**：
- 添加了第8种："AI推荐方案一键预订订单"
- 单号规则：`BK+AI+年月日时分秒+五位顺序号`

---

### 4. 网站页面结构图.md

#### 更新位置1：AI预订流程（2.2节）
**更新前**：
```
├── AI推荐方案列表
│   └── 推荐方案详情 → 一键预订
```

**更新后**：
```
├── AI推荐方案列表
│   └── 推荐方案详情 → 一键预订（生成订单号：BK+AI+...）
```

#### 更新位置2：AI推荐方案生成路径（2.4节）
**更新前**：
```
└── 所有推荐方案 → 详情页 → 一键预订
```

**更新后**：
```
└── 所有推荐方案 → 详情页 → 一键预订（生成订单号：BK+AI+...）
```

#### 更新位置3：AI推荐方案详情页（核心功能页面）
**更新前**：
```
└── 一键预订按钮
```

**更新后**：
```
└── 一键预订按钮（生成订单号：BK+AI+年月日时分秒+五位顺序号）
```

---

## ✅ 更新验证

### 单号规则完整性检查
现在所有8种业务类型的单号规则都已完整：

1. ✅ 页面提交出差申请：`BTRQ+JD+年月日时分秒+四位顺序号`
2. ✅ AI对话生成出差申请：`BTRQ+AI+年月日时分秒+四位顺序号`
3. ✅ 经典预订订单：`BK+TR+年月日时分秒+五位顺序号`
4. ✅ **AI推荐方案一键预订订单**：`BK+AI+年月日时分秒+五位顺序号` ⭐ **新增**
5. ✅ 申请单自动推荐：`AIRD+ZDT+年月日时分秒+五位顺序号`
6. ✅ 申请单重新推荐：`AIRD+GXH+年月日时分秒+五位顺序号`
7. ✅ 对话生成推荐：`AIRD+AIC+年月日时分秒+五位顺序号`
8. ✅ 对话重新推荐：`AIRD+GXC+年月日时分秒+五位顺序号`

### 数据库函数完整性检查
- ✅ `generate_travel_request_no()` - 支持生成BTRQ+JD和BTRQ+AI
- ✅ `generate_order_no()` - 支持生成BK+TR和BK+AI（已更新）
- ✅ `generate_recommendation_no()` - 支持生成所有AIRD+前缀的单号

---

## 🔧 开发注意事项

### 1. 订单号生成调用方式

**经典预订**：
```sql
SELECT generate_order_no('classic');
-- 或
SELECT generate_order_no(); -- 默认就是classic
-- 结果：BK+TR+20241219143025+00001
```

**AI推荐方案一键预订**：
```sql
SELECT generate_order_no('ai_recommendation');
-- 结果：BK+AI+20241219143025+00001
```

### 2. 前端调用建议

在创建订单时，需要根据 `booking_source` 字段调用对应的订单号生成逻辑：

```javascript
// 经典预订
const orderNo = await generateOrderNo('classic');

// AI推荐方案一键预订
const orderNo = await generateOrderNo('ai_recommendation');
```

### 3. 数据库插入示例

```sql
-- 经典预订订单
INSERT INTO orders (order_no, booking_source, ...)
VALUES (generate_order_no('classic'), 'classic', ...);

-- AI推荐方案一键预订订单
INSERT INTO orders (order_no, booking_source, ai_recommendation_id, ...)
VALUES (generate_order_no('ai_recommendation'), 'ai_recommendation', '...', ...);
```

---

## 📋 更新文件清单

- [x] YQFAIBTRIP需求文档.md
- [x] 数据库设计文档.md
- [x] 项目文档总览.md
- [x] 网站页面结构图.md
- [x] 文档更新说明.md（本文件）

---

## ✨ 总结

本次更新完善了AI推荐方案一键预订功能的订单号生成规则，确保了：
1. ✅ 所有单号规则完整且一致
2. ✅ 数据库函数支持两种订单号生成
3. ✅ 文档中所有相关说明都已更新
4. ✅ 开发人员可以清楚地区分两种预订方式

**所有文档已同步更新，可以开始开发！** 🚀

