# 密钥长度错误修复说明

## ❌ 问题描述

在测试航班查询接口时，出现错误：
```
"密钥长度必须为16或32字节"
```

## 🔍 问题原因

1. **用户输入的App Secret可能包含首尾空格**
   - 复制粘贴时可能带入空格
   - 输入框前后可能有隐藏的空格

2. **密钥长度验证不够友好**
   - 错误信息没有显示当前长度
   - 没有提示如何修复

3. **缺少实时验证**
   - 只在调用API时才验证
   - 用户填写时没有即时反馈

## ✅ 已修复的问题

### 1. 自动去除首尾空格

**位置**: `src/pages/Test/YQFAPITest.tsx`

- ✅ 在获取配置时自动 `trim()` 处理
- ✅ 在输入框失焦时自动去除空格
- ✅ 在加密函数中也添加了 `trim()` 保护

### 2. 增强的表单验证

**位置**: `src/pages/Test/YQFAPITest.tsx` - App Secret输入框

- ✅ 添加了实时长度验证
- ✅ 显示字符计数（`showCount`）
- ✅ 限制最大长度为32字节
- ✅ 失焦时自动去除空格
- ✅ 友好的错误提示

### 3. 改进的错误提示

**位置**: `src/lib/yqf-air/crypto.ts`

- ✅ 错误信息显示当前长度
- ✅ 提示检查空格问题
- ✅ 更明确的修复建议

### 4. 客户端额外保护

**位置**: `src/lib/yqf-air/client.ts`

- ✅ 在调用API前再次验证密钥长度
- ✅ 使用处理后的密钥（已trim）

## 📋 修复详情

### 修复1: 配置获取函数

```typescript
// 处理App Secret：去除首尾空格
const rawAppSecret = (configValues.appSecret || config.appSecret || '').trim()

// 验证App Secret长度（必须是16或32字节）
if (currentConfig.appSecret.length !== 16 && currentConfig.appSecret.length !== 32) {
  message.error(`App Secret长度不正确：当前长度为${currentConfig.appSecret.length}字节，必须是16或32字节。请检查是否有多余的空格或字符。`)
  return null
}
```

### 修复2: 表单验证规则

```typescript
rules={[
  { required: true, message: '请输入App Secret' },
  {
    validator: (_, value) => {
      if (!value) {
        return Promise.resolve()
      }
      const trimmed = value.trim()
      if (trimmed.length !== 16 && trimmed.length !== 32) {
        return Promise.reject(new Error('App Secret长度必须是16或32字节（当前：' + trimmed.length + '字节）'))
      }
      return Promise.resolve()
    },
  },
]}
```

### 修复3: 输入框自动处理

```typescript
<Input.Password 
  placeholder="your_app_secret (16或32字节)" 
  maxLength={32}
  showCount
  onBlur={(e) => {
    // 自动去除首尾空格
    const trimmed = e.target.value.trim()
    if (trimmed !== e.target.value) {
      configForm.setFieldValue('appSecret', trimmed)
    }
  }}
/>
```

### 修复4: 加密函数保护

```typescript
static encrypt(plainText: string, secretKey: string): string {
  // 去除首尾空格
  const trimmedKey = secretKey.trim()
  
  // 确保密钥长度为16或32字节
  if (trimmedKey.length !== 16 && trimmedKey.length !== 32) {
    throw new Error(`密钥长度必须为16或32字节，当前长度为${trimmedKey.length}字节。请检查密钥是否正确，确保没有多余的空格。`)
  }
  
  // 使用处理后的密钥
  const key = CryptoJS.enc.Utf8.parse(trimmedKey)
  // ...
}
```

## 🧪 测试步骤

1. **打开测试页面**
   ```
   http://localhost:3000/test/yqf-api
   ```

2. **填写配置**
   - 切换到"配置"标签页
   - 填写App Secret（可以故意在前后加空格测试）

3. **验证自动处理**
   - 输入框失焦时，空格会自动去除
   - 如果长度不对，会显示错误提示
   - 字符计数会显示当前长度

4. **测试API调用**
   - 切换到"航班查询"标签页
   - 填写查询参数
   - 点击"查询航班"
   - 应该不再出现密钥长度错误

## ✅ 预期结果

- ✅ 输入框自动去除首尾空格
- ✅ 实时显示字符计数
- ✅ 长度不符合要求时显示友好错误
- ✅ API调用时不再出现密钥长度错误

## 📝 注意事项

1. **密钥长度要求**
   - 必须是 **16字节** 或 **32字节**
   - 不能多也不能少

2. **常见问题**
   - 复制粘贴时可能带入空格 → 已自动处理
   - 输入时可能多输入字符 → 已限制最大长度
   - 长度不符合要求 → 已添加实时验证

3. **如果仍然出错**
   - 检查密钥是否真的是16或32字节
   - 检查是否有特殊字符
   - 查看浏览器控制台的详细错误信息

---

**修复完成时间**: 2025-11-22  
**状态**: ✅ 已修复并测试

