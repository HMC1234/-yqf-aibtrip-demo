# 快速设置审批权限指南

## 🔍 问题诊断

如果您登录了 `test@example.com` 账号后看不到"审批"按钮，可能是以下原因：

1. **数据库字段不存在**：`users` 表中还没有 `can_approve` 字段
2. **权限未设置**：用户记录中的 `can_approve` 字段值为 `false` 或 `NULL`
3. **数据库迁移脚本未执行**：还没有执行添加审批权限字段的SQL脚本

## ✅ 解决方案

### 方法一：使用综合脚本（推荐）

在 **Supabase SQL Editor** 中执行 `检查并设置审批权限.sql` 脚本，这个脚本会：

1. ✅ 自动检查并添加 `can_approve` 字段（如果不存在）
2. ✅ 显示 `test@example.com` 用户的当前权限状态
3. ✅ 将 `test@example.com` 用户的审批权限设置为 `true`
4. ✅ 验证权限设置是否成功
5. ✅ 为所有现有用户设置默认权限

**执行步骤**：
1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 复制 `检查并设置审批权限.sql` 的全部内容
4. 粘贴到 SQL Editor 中
5. 点击 "Run" 执行
6. 查看执行结果，确认权限已设置

---

### 方法二：分步执行

如果您想分步执行，可以按以下顺序：

#### 步骤 1：添加审批权限字段（如果还没有）

```sql
-- 检查字段是否存在，不存在则添加
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS can_approve BOOLEAN DEFAULT true;
```

#### 步骤 2：查看 test@example.com 用户的当前状态

```sql
SELECT 
    id,
    email,
    full_name,
    can_approve,
    role
FROM users
WHERE email = 'test@example.com';
```

#### 步骤 3：设置审批权限

```sql
UPDATE users 
SET can_approve = true,
    updated_at = NOW()
WHERE email = 'test@example.com';
```

#### 步骤 4：验证权限已设置

```sql
SELECT 
    email,
    can_approve,
    CASE 
        WHEN can_approve = true THEN '有权限 ✓'
        WHEN can_approve = false THEN '无权限 ✗'
        ELSE '未设置（NULL）'
    END AS 权限状态
FROM users
WHERE email = 'test@example.com';
```

---

## 🔄 设置后的操作

执行SQL脚本后：

1. **刷新浏览器页面**：由于前端会缓存用户信息，建议刷新页面或重新登录
2. **清除浏览器缓存**（可选）：如果仍然看不到按钮，可以清除浏览器缓存
3. **检查控制台**：打开浏览器开发者工具（F12），查看 Console 是否有错误信息

---

## 🐛 故障排查

### 问题 1：执行SQL后仍然看不到按钮

**可能原因**：
- 前端代码还没有重新加载用户权限
- 浏览器缓存了旧的用户数据

**解决方法**：
1. 完全退出登录，然后重新登录
2. 清除浏览器缓存和 Cookie
3. 检查浏览器控制台是否有错误信息

### 问题 2：SQL执行报错

**可能错误**：
- `column "can_approve" does not exist`：说明字段不存在，需要先执行添加字段的SQL

**解决方法**：
先执行添加字段的SQL：
```sql
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS can_approve BOOLEAN DEFAULT true;
```

### 问题 3：权限设置了但仍然看不到

**检查清单**：
1. ✅ 确认申请单状态为 `pending`（待审批）
   - 只有在"待审批"状态的申请单才会显示审批按钮
2. ✅ 确认用户权限为 `true`
   ```sql
   SELECT email, can_approve FROM users WHERE email = 'test@example.com';
   ```
3. ✅ 检查浏览器控制台是否有错误
   - 打开 F12 → Console 标签
   - 查看是否有 `加载审批权限失败` 的错误

---

## 📝 验证步骤

设置权限后，请按以下步骤验证：

### 1. 验证数据库权限

```sql
SELECT 
    email,
    can_approve,
    CASE 
        WHEN can_approve = true THEN '✅ 有权限'
        ELSE '❌ 无权限'
    END AS 状态
FROM users
WHERE email = 'test@example.com';
```

**预期结果**：`can_approve` 应该为 `true`

### 2. 验证前端权限

1. 登录 `test@example.com` 账号
2. 进入"个人中心" → "个人信息"标签页
3. 找到"审批权限"字段
4. 开关应该显示为"有权限"状态

### 3. 验证审批按钮显示

1. 进入"出差申请" → "我的出差申请"
2. 点击"待审批"标签页
3. 如果有"待审批"状态的申请单，应该能看到"审批"按钮

---

## 🎯 快速修复命令

如果您想快速修复，可以直接在 Supabase SQL Editor 中执行以下命令：

```sql
-- 一键修复：添加字段 + 设置权限
ALTER TABLE users ADD COLUMN IF NOT EXISTS can_approve BOOLEAN DEFAULT true;
UPDATE users SET can_approve = true WHERE email = 'test@example.com';
SELECT email, can_approve FROM users WHERE email = 'test@example.com';
```

执行后，如果最后一条 SELECT 查询显示 `can_approve = true`，说明权限已设置成功！

---

## 📞 如果仍有问题

如果按照以上步骤操作后仍然看不到审批按钮，请提供：

1. SQL 执行结果截图
2. 浏览器控制台（Console）的错误信息
3. 申请单的状态（是否是 `pending`）

这样我可以进一步帮您诊断问题。

