# YQFAIBTRIP 数据库设计文档 (Supabase)

## 1. 数据库概述

### 1.1 数据库平台
- **平台**：Supabase (PostgreSQL)
- **字符集**：UTF-8
- **时区**：UTC（存储时统一转换为UTC，显示时根据用户时区转换）

### 1.2 命名规范
- 表名：小写，单词间用下划线分隔，复数形式
- 字段名：小写，单词间用下划线分隔
- 主键：统一使用 `id` (UUID类型)
- 外键：`表名_id` 格式
- 时间字段：统一使用 `created_at`, `updated_at`, `deleted_at`

---

## 2. 数据表设计

### 2.1 用户相关表

#### 2.1.1 users (用户表)
**说明**：存储用户基本信息，Supabase Auth会自动创建auth.users表，此表作为扩展表关联

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, FK → auth.users.id | 用户ID（关联Supabase Auth） |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 邮箱 |
| username | VARCHAR(50) | UNIQUE | 用户名（test为默认测试用户） |
| full_name | VARCHAR(100) | | 姓名 |
| phone | VARCHAR(20) | | 手机号 |
| company_id | UUID | FK → companies.id | 所属公司ID |
| department_id | UUID | FK → departments.id | 所属部门ID |
| cost_center_id | UUID | FK → cost_centers.id | 成本中心ID |
| role | VARCHAR(50) | DEFAULT 'employee' | 角色（employee/admin/approver） |
| avatar_url | TEXT | | 头像URL |
| is_active | BOOLEAN | DEFAULT true | 是否激活 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_users_company_id` ON users(company_id)
- `idx_users_email` ON users(email)
- `idx_users_username` ON users(username)

---

#### 2.1.2 companies (公司表)
**说明**：存储企业客户信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 公司ID |
| name | VARCHAR(200) | NOT NULL | 公司名称 |
| code | VARCHAR(50) | UNIQUE | 公司代码 |
| contact_name | VARCHAR(100) | | 联系人姓名 |
| contact_phone | VARCHAR(20) | | 联系人电话 |
| contact_email | VARCHAR(255) | | 联系人邮箱 |
| address | TEXT | | 公司地址 |
| is_active | BOOLEAN | DEFAULT true | 是否激活 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_companies_code` ON companies(code)

---

#### 2.1.3 departments (部门表)
**说明**：存储部门信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 部门ID |
| company_id | UUID | FK → companies.id, NOT NULL | 所属公司ID |
| name | VARCHAR(100) | NOT NULL | 部门名称 |
| code | VARCHAR(50) | | 部门代码 |
| parent_id | UUID | FK → departments.id | 上级部门ID（支持层级） |
| manager_id | UUID | FK → users.id | 部门经理ID |
| is_active | BOOLEAN | DEFAULT true | 是否激活 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_departments_company_id` ON departments(company_id)
- `idx_departments_parent_id` ON departments(parent_id)

---

#### 2.1.4 cost_centers (成本中心表)
**说明**：存储成本中心信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 成本中心ID |
| company_id | UUID | FK → companies.id, NOT NULL | 所属公司ID |
| code | VARCHAR(50) | NOT NULL | 成本中心代码 |
| name | VARCHAR(100) | NOT NULL | 成本中心名称 |
| budget_limit | DECIMAL(12,2) | | 预算限额 |
| is_active | BOOLEAN | DEFAULT true | 是否激活 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_cost_centers_company_id` ON cost_centers(company_id)
- `idx_cost_centers_code` ON cost_centers(code)

---

### 2.2 出差申请相关表

#### 2.2.1 travel_requests (出差申请单表)
**说明**：存储出差申请单主信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 申请单ID |
| request_no | VARCHAR(50) | UNIQUE, NOT NULL | 申请单号（BTRQ+JD/AI+...） |
| user_id | UUID | FK → users.id, NOT NULL | 申请人ID |
| company_id | UUID | FK → companies.id, NOT NULL | 公司ID |
| department_id | UUID | FK → departments.id | 部门ID |
| cost_center_id | UUID | FK → cost_centers.id, NOT NULL | 成本中心ID |
| origin | VARCHAR(100) | NOT NULL | 出发地 |
| destination | VARCHAR(100) | NOT NULL | 目的地 |
| departure_date | DATE | NOT NULL | 出发日期 |
| return_date | DATE | NOT NULL | 回程日期 |
| reason | TEXT | NOT NULL | 出差原因 |
| products | JSONB | NOT NULL | 需要预订的产品（["flight","hotel","train","car"]） |
| status | VARCHAR(50) | DEFAULT 'pending' | 状态（pending/approving/approved/rejected） |
| source | VARCHAR(50) | DEFAULT 'manual' | 来源（manual/ai_chat） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_travel_requests_user_id` ON travel_requests(user_id)
- `idx_travel_requests_status` ON travel_requests(status)
- `idx_travel_requests_request_no` ON travel_requests(request_no)
- `idx_travel_requests_company_id` ON travel_requests(company_id)

**约束**：
- CHECK (return_date >= departure_date)

---

#### 2.2.2 approval_records (审批记录表)
**说明**：存储审批流程记录

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 审批记录ID |
| travel_request_id | UUID | FK → travel_requests.id, NOT NULL | 出差申请单ID |
| approver_id | UUID | FK → users.id, NOT NULL | 审批人ID |
| approval_level | INTEGER | DEFAULT 1 | 审批层级（1,2,3...） |
| status | VARCHAR(50) | NOT NULL | 审批状态（pending/approved/rejected） |
| comment | TEXT | | 审批意见 |
| approved_at | TIMESTAMPTZ | | 审批时间 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**：
- `idx_approval_records_travel_request_id` ON approval_records(travel_request_id)
- `idx_approval_records_approver_id` ON approval_records(approver_id)

---

### 2.3 预订相关表

#### 2.3.1 orders (预订单表)
**说明**：存储预订单主信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 订单ID |
| order_no | VARCHAR(50) | UNIQUE, NOT NULL | 订单号（BK+TR+... 或 BK+AI+...） |
| user_id | UUID | FK → users.id, NOT NULL | 用户ID |
| travel_request_id | UUID | FK → travel_requests.id | 关联出差申请单ID（可为空） |
| ai_recommendation_id | UUID | FK → ai_recommendations.id | 关联AI推荐方案ID（可为空） |
| product_type | VARCHAR(50) | NOT NULL | 产品类型（flight/hotel/train/car） |
| product_details | JSONB | NOT NULL | 产品详细信息 |
| origin | VARCHAR(100) | | 出发地 |
| destination | VARCHAR(100) | | 目的地 |
| departure_date | DATE | | 出发日期 |
| return_date | DATE | | 回程日期（酒店/用车可能为空） |
| total_amount | DECIMAL(12,2) | NOT NULL | 订单总金额 |
| currency | VARCHAR(10) | DEFAULT 'CNY' | 币种 |
| status | VARCHAR(50) | DEFAULT 'pending' | 订单状态（pending/confirmed/cancelled/completed） |
| booking_source | VARCHAR(50) | DEFAULT 'classic' | 预订来源（classic=经典预订生成BK+TR订单号，ai_recommendation=AI推荐一键预订生成BK+AI订单号） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_orders_user_id` ON orders(user_id)
- `idx_orders_order_no` ON orders(order_no)
- `idx_orders_travel_request_id` ON orders(travel_request_id)
- `idx_orders_status` ON orders(status)

---

#### 2.3.2 search_records (用户搜索记录表)
**说明**：存储用户经典预订的搜索记录，用于分析用户偏好和优化AI推荐

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 搜索记录ID |
| user_id | UUID | FK → users.id, NOT NULL | 用户ID |
| product_type | VARCHAR(50) | NOT NULL | 产品类型（flight/hotel/train/car） |
| origin | VARCHAR(100) | | 出发地 |
| destination | VARCHAR(100) | | 目的地 |
| departure_date | DATE | | 出发日期 |
| return_date | DATE | | 回程日期（酒店/用车可能为空） |
| check_in_date | DATE | | 入住日期（仅酒店） |
| check_out_date | DATE | | 退房日期（仅酒店） |
| passenger_count | INTEGER | DEFAULT 1 | 乘客/房间数量 |
| search_params | JSONB | | 其他搜索参数（如舱位、星级、座位类型等） |
| search_source | VARCHAR(50) | DEFAULT 'independent' | 搜索来源（independent/travel_request） |
| travel_request_id | UUID | FK → travel_requests.id | 关联出差申请单ID（如果从申请单跳转） |
| has_order | BOOLEAN | DEFAULT false | 是否生成订单（搜索后是否实际预订） |
| order_id | UUID | FK → orders.id | 关联订单ID（如果生成了订单） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 搜索时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_search_records_user_id` ON search_records(user_id)
- `idx_search_records_product_type` ON search_records(product_type)
- `idx_search_records_created_at` ON search_records(created_at DESC)
- `idx_search_records_travel_request_id` ON search_records(travel_request_id)
- `idx_search_records_destination` ON search_records(destination)
- `idx_search_records_user_product` ON search_records(user_id, product_type)

**说明**：
- 每次用户进行经典预订搜索时，自动创建一条搜索记录
- 如果用户从搜索结果中生成订单，更新 `has_order` 和 `order_id` 字段
- 支持用户查看和删除自己的搜索历史
- 用于分析用户偏好，优化AI推荐算法

---

### 2.4 AI推荐相关表

#### 2.4.1 ai_recommendations (AI推荐方案表)
**说明**：存储AI推荐方案主信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 推荐方案ID |
| recommendation_no | VARCHAR(50) | UNIQUE, NOT NULL | 推荐单号（AIRD+ZDT/GXH/AIC/GXC+...） |
| user_id | UUID | FK → users.id, NOT NULL | 用户ID |
| travel_request_id | UUID | FK → travel_requests.id | 关联出差申请单ID（可为空） |
| source | VARCHAR(50) | NOT NULL | 来源（travel_request/ai_chat） |
| source_type | VARCHAR(50) | NOT NULL | 来源类型（auto/regenerate） |
| keywords | JSONB | | 用户选择的关键字（数组） |
| origin | VARCHAR(100) | NOT NULL | 出发地 |
| destination | VARCHAR(100) | NOT NULL | 目的地 |
| departure_date | DATE | NOT NULL | 出发日期 |
| return_date | DATE | NOT NULL | 回程日期 |
| products | JSONB | NOT NULL | 需要预订的产品（["flight","hotel","train","car"]） |
| status | VARCHAR(50) | DEFAULT 'generated' | 状态（generating/generated/booked/cancelled） |
| generated_at | TIMESTAMPTZ | | 生成时间 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_ai_recommendations_user_id` ON ai_recommendations(user_id)
- `idx_ai_recommendations_travel_request_id` ON ai_recommendations(travel_request_id)
- `idx_ai_recommendations_recommendation_no` ON ai_recommendations(recommendation_no)
- `idx_ai_recommendations_status` ON ai_recommendations(status)

---

#### 2.4.2 recommendation_details (推荐方案详情表)
**说明**：存储每个推荐方案的具体推荐内容（一个推荐方案包含3-5个方案选项）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 详情ID |
| ai_recommendation_id | UUID | FK → ai_recommendations.id, NOT NULL | 推荐方案ID |
| option_index | INTEGER | NOT NULL | 方案序号（1,2,3,4,5） |
| product_type | VARCHAR(50) | NOT NULL | 产品类型（flight/hotel/train/car） |
| product_data | JSONB | NOT NULL | 产品详细数据 |
| keywords | TEXT[] | | 核心关键字数组 |
| reason | TEXT | | 推荐原因说明 |
| price | DECIMAL(12,2) | | 价格 |
| currency | VARCHAR(10) | DEFAULT 'CNY' | 币种 |
| policy_compliance | BOOLEAN | DEFAULT true | 是否符合差旅政策 |
| score | DECIMAL(5,2) | | 推荐评分（0-100） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |

**索引**：
- `idx_recommendation_details_ai_recommendation_id` ON recommendation_details(ai_recommendation_id)
- `idx_recommendation_details_product_type` ON recommendation_details(product_type)

---

#### 2.4.3 chat_messages (对话记录表)
**说明**：存储智能对话的聊天记录

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 消息ID |
| user_id | UUID | FK → users.id, NOT NULL | 用户ID |
| session_id | UUID | NOT NULL | 会话ID（一次对话一个session） |
| role | VARCHAR(20) | NOT NULL | 角色（user/assistant/system） |
| content | TEXT | NOT NULL | 消息内容 |
| metadata | JSONB | | 元数据（如提取的出差信息） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |

**索引**：
- `idx_chat_messages_user_id` ON chat_messages(user_id)
- `idx_chat_messages_session_id` ON chat_messages(session_id)
- `idx_chat_messages_created_at` ON chat_messages(created_at)

---

#### 2.4.4 keywords (关键字表)
**说明**：存储推荐关键字选项（预设关键字）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 关键字ID |
| category | VARCHAR(50) | NOT NULL | 分类（flight/hotel/train/car） |
| keyword | VARCHAR(100) | NOT NULL | 关键字文本 |
| description | TEXT | | 关键字描述 |
| priority | INTEGER | DEFAULT 0 | 优先级（排序用） |
| is_active | BOOLEAN | DEFAULT true | 是否启用 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**索引**：
- `idx_keywords_category` ON keywords(category)
- `idx_keywords_priority` ON keywords(priority DESC)

---

### 2.5 差旅政策相关表

#### 2.5.1 travel_policies (差旅政策表)
**说明**：存储公司差旅政策

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | 政策ID |
| company_id | UUID | FK → companies.id, NOT NULL | 公司ID |
| policy_name | VARCHAR(200) | NOT NULL | 政策名称 |
| policy_type | VARCHAR(50) | NOT NULL | 政策类型（flight/hotel/train/car/general） |
| policy_rules | JSONB | NOT NULL | 政策规则（JSON格式） |
| is_active | BOOLEAN | DEFAULT true | 是否启用 |
| effective_date | DATE | | 生效日期 |
| expiry_date | DATE | | 失效日期 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | | 软删除时间 |

**索引**：
- `idx_travel_policies_company_id` ON travel_policies(company_id)
- `idx_travel_policies_policy_type` ON travel_policies(policy_type)

---

### 2.6 系统配置表

#### 2.6.1 sequence_numbers (单号序列表)
**说明**：存储单号生成的序列号（用于生成唯一顺序号）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | ID |
| prefix | VARCHAR(20) | NOT NULL | 单号前缀（如BTRQ+JD, AIRD+ZDT等） |
| date_str | VARCHAR(8) | NOT NULL | 日期字符串（YYYYMMDD） |
| sequence | INTEGER | DEFAULT 0 | 当前序列号 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |

**唯一约束**：
- UNIQUE(prefix, date_str)

**索引**：
- `idx_sequence_numbers_prefix_date` ON sequence_numbers(prefix, date_str)

---

## 3. 数据库函数和触发器

### 3.1 单号生成函数
```sql
-- 生成出差申请单号
CREATE OR REPLACE FUNCTION generate_travel_request_no(
    source_type VARCHAR -- 'JD' 或 'AI'
) RETURNS VARCHAR AS $$
DECLARE
    date_str VARCHAR(8);
    time_str VARCHAR(6);
    prefix VARCHAR(20);
    seq_num INTEGER;
    result_no VARCHAR(50);
BEGIN
    date_str := TO_CHAR(NOW(), 'YYYYMMDD');
    time_str := TO_CHAR(NOW(), 'HH24MISS');
    prefix := 'BTRQ+' || source_type;
    
    -- 获取或创建序列号
    INSERT INTO sequence_numbers (prefix, date_str, sequence)
    VALUES (prefix, date_str, 1)
    ON CONFLICT (prefix, date_str)
    DO UPDATE SET sequence = sequence_numbers.sequence + 1
    RETURNING sequence INTO seq_num;
    
    result_no := prefix || '+' || date_str || time_str || '+' || LPAD(seq_num::TEXT, 4, '0');
    RETURN result_no;
END;
$$ LANGUAGE plpgsql;

-- 生成预订单号
CREATE OR REPLACE FUNCTION generate_order_no(
    booking_source VARCHAR DEFAULT 'classic' -- 'classic' 或 'ai_recommendation'
) RETURNS VARCHAR AS $$
DECLARE
    date_str VARCHAR(8);
    time_str VARCHAR(6);
    prefix VARCHAR(20);
    seq_num INTEGER;
    result_no VARCHAR(50);
BEGIN
    date_str := TO_CHAR(NOW(), 'YYYYMMDD');
    time_str := TO_CHAR(NOW(), 'HH24MISS');
    
    -- 根据预订来源确定前缀
    IF booking_source = 'ai_recommendation' THEN
        prefix := 'BK+AI';
    ELSE
        prefix := 'BK+TR';
    END IF;
    
    INSERT INTO sequence_numbers (prefix, date_str, sequence)
    VALUES (prefix, date_str, 1)
    ON CONFLICT (prefix, date_str)
    DO UPDATE SET sequence = sequence_numbers.sequence + 1
    RETURNING sequence INTO seq_num;
    
    result_no := prefix || '+' || date_str || time_str || '+' || LPAD(seq_num::TEXT, 5, '0');
    RETURN result_no;
END;
$$ LANGUAGE plpgsql;

-- 生成AI推荐单号
CREATE OR REPLACE FUNCTION generate_recommendation_no(
    source_type VARCHAR -- 'ZDT', 'GXH', 'AIC', 'GXC'
) RETURNS VARCHAR AS $$
DECLARE
    date_str VARCHAR(8);
    time_str VARCHAR(6);
    prefix VARCHAR(20);
    seq_num INTEGER;
    result_no VARCHAR(50);
BEGIN
    date_str := TO_CHAR(NOW(), 'YYYYMMDD');
    time_str := TO_CHAR(NOW(), 'HH24MISS');
    prefix := 'AIRD+' || source_type;
    
    INSERT INTO sequence_numbers (prefix, date_str, sequence)
    VALUES (prefix, date_str, 1)
    ON CONFLICT (prefix, date_str)
    DO UPDATE SET sequence = sequence_numbers.sequence + 1
    RETURNING sequence INTO seq_num;
    
    result_no := prefix || '+' || date_str || time_str || '+' || LPAD(seq_num::TEXT, 5, '0');
    RETURN result_no;
END;
$$ LANGUAGE plpgsql;
```

### 3.2 自动更新时间戳触发器
```sql
-- 创建更新时间戳函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 为所有表添加触发器（示例）
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 类似地为其他表创建触发器...
```

---

## 4. 视图设计

### 4.1 用户完整信息视图
```sql
CREATE VIEW v_user_full_info AS
SELECT 
    u.id,
    u.email,
    u.username,
    u.full_name,
    u.phone,
    c.name AS company_name,
    d.name AS department_name,
    cc.name AS cost_center_name,
    u.role,
    u.is_active
FROM users u
LEFT JOIN companies c ON u.company_id = c.id
LEFT JOIN departments d ON u.department_id = d.id
LEFT JOIN cost_centers cc ON u.cost_center_id = cc.id
WHERE u.deleted_at IS NULL;
```

### 4.2 出差申请单详情视图
```sql
CREATE VIEW v_travel_request_detail AS
SELECT 
    tr.id,
    tr.request_no,
    tr.origin,
    tr.destination,
    tr.departure_date,
    tr.return_date,
    tr.reason,
    tr.products,
    tr.status,
    u.full_name AS applicant_name,
    c.name AS company_name,
    d.name AS department_name,
    cc.name AS cost_center_name,
    tr.created_at,
    tr.updated_at
FROM travel_requests tr
LEFT JOIN users u ON tr.user_id = u.id
LEFT JOIN companies c ON tr.company_id = c.id
LEFT JOIN departments d ON tr.department_id = d.id
LEFT JOIN cost_centers cc ON tr.cost_center_id = cc.id
WHERE tr.deleted_at IS NULL;
```

---

## 5. 数据初始化

### 5.1 默认测试用户
```sql
-- 插入测试公司
INSERT INTO companies (id, name, code) 
VALUES ('00000000-0000-0000-0000-000000000001', '测试公司', 'TEST001');

-- 插入测试部门
INSERT INTO departments (id, company_id, name, code)
VALUES ('00000000-0000-0000-0000-000000000002', '00000000-0000-0000-0000-000000000001', '技术部', 'TECH001');

-- 插入测试成本中心
INSERT INTO cost_centers (id, company_id, code, name)
VALUES ('00000000-0000-0000-0000-000000000003', '00000000-0000-0000-0000-000000000001', 'CC001', '技术成本中心');

-- 注意：users表需要通过Supabase Auth创建，然后在此表中关联
```

### 5.2 预设关键字数据
```sql
-- 机票关键字
INSERT INTO keywords (category, keyword, description, priority) VALUES
('flight', '选择大飞机', '优先选择大型客机', 10),
('flight', '上午最低价', '选择上午时段最低价格航班', 9),
('flight', '下午出发', '优先选择下午出发的航班', 8),
('flight', '直飞优先', '优先选择直飞航班', 10),
('flight', '经济舱', '选择经济舱', 5),
('flight', '商务舱', '选择商务舱', 7),
('flight', '最短飞行时间', '优先选择飞行时间最短的航班', 9),
('flight', '最低价格', '优先选择价格最低的航班', 10);

-- 酒店关键字
INSERT INTO keywords (category, keyword, description, priority) VALUES
('hotel', '五星级酒店', '选择五星级酒店', 10),
('hotel', '四星级酒店', '选择四星级酒店', 8),
('hotel', '市中心位置', '优先选择市中心位置的酒店', 9),
('hotel', '机场附近', '优先选择机场附近的酒店', 7),
('hotel', '最低价格', '优先选择价格最低的酒店', 10),
('hotel', '最高评分', '优先选择评分最高的酒店', 9),
('hotel', '含早餐', '选择含早餐的酒店', 6),
('hotel', '免费WiFi', '选择提供免费WiFi的酒店', 5),
('hotel', '健身房', '选择有健身房的酒店', 4),
('hotel', '商务中心', '选择有商务中心的酒店', 5);

-- 火车票关键字
INSERT INTO keywords (category, keyword, description, priority) VALUES
('train', '高铁优先', '优先选择高铁', 10),
('train', '动车优先', '优先选择动车', 8),
('train', '最短时间', '优先选择时间最短的车次', 9),
('train', '最低价格', '优先选择价格最低的车次', 10),
('train', '商务座', '选择商务座', 7),
('train', '一等座', '选择一等座', 6);

-- 用车关键字
INSERT INTO keywords (category, keyword, description, priority) VALUES
('car', '经济型', '选择经济型车辆', 5),
('car', '舒适型', '选择舒适型车辆', 7),
('car', '豪华型', '选择豪华型车辆', 9),
('car', '7座商务车', '选择7座商务车', 8),
('car', '专车服务', '选择专车服务', 10);
```

---

## 6. Row Level Security (RLS) 策略

### 6.1 用户数据访问策略
```sql
-- 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE travel_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE search_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE ai_recommendations ENABLE ROW LEVEL SECURITY;

-- 用户只能查看自己的数据
CREATE POLICY "Users can view own data" ON users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can view own travel requests" ON travel_requests
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view own orders" ON orders
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can view own search records" ON search_records
    FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own search records" ON search_records
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete own search records" ON search_records
    FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own recommendations" ON ai_recommendations
    FOR SELECT USING (auth.uid() = user_id);
```

---

## 7. 数据库维护建议

### 7.1 定期清理
- 软删除数据定期归档（如6个月后）
- 日志数据定期清理
- 过期会话数据清理

### 7.2 性能优化
- 定期分析表统计信息
- 监控慢查询
- 根据查询模式调整索引

### 7.3 备份策略
- 每日自动备份
- 保留30天备份
- 重要操作前手动备份

---

## 8. 数据迁移脚本

### 8.1 创建所有表的SQL脚本
建议将上述所有表结构整理成完整的SQL脚本，便于在Supabase中执行。

### 8.2 版本控制
建议使用数据库迁移工具（如Supabase Migrations）管理数据库版本。

---

## 9. 注意事项

1. **UUID生成**：确保Supabase已启用uuid扩展：`CREATE EXTENSION IF NOT EXISTS "uuid-ossp";`
2. **时区处理**：所有时间字段使用TIMESTAMPTZ，存储UTC时间
3. **JSONB字段**：合理使用JSONB存储灵活结构数据，但避免过度嵌套
4. **索引优化**：根据实际查询模式调整索引
5. **外键约束**：确保数据完整性，但注意删除时的级联处理
6. **软删除**：使用deleted_at字段实现软删除，保留数据历史

