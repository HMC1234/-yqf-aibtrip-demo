# YQFAIBTRIP 文档优化内容清单

**创建日期**：2024-12-19  
**状态**：待确认  
**说明**：本文档列出了所有需要优化的内容，请确认后统一更新到相关文档中

---

## 📋 优化内容分类

### 🔴 高优先级（必须补充，影响开发）

#### 1. 模拟数据使用说明 ⭐ **新增**
**位置**：需求文档 - 项目概述或技术实现要求章节

**内容**：
```markdown
### 1.4 开发阶段数据说明

#### 1.4.1 企业组织架构数据（第一阶段使用模拟数据）
**说明**：
- 由于系统在第二阶段要对接企业客户系统，因此第一阶段（MVP）采用模拟数据
- 模拟数据包括：公司、部门、成本中心、员工等信息
- 目的：便于系统跑通，验证业务流程

**模拟数据范围**：
- 公司信息（公司名称、代码、联系人等）
- 部门信息（部门名称、层级关系、部门经理等）
- 成本中心（成本中心代码、名称、预算等）
- 员工信息（姓名、邮箱、所属部门、成本中心等）

**第二阶段计划**：
- 对接企业客户系统（如OA系统、HR系统等）
- 通过API同步企业组织架构数据
- 支持多企业数据隔离

#### 1.4.2 差旅产品数据（第一阶段使用模拟数据）
**说明**：
- 有关机票、酒店、火车票和用车数据会在第二阶段接入真正实时的对应产品的API获取真实数据
- 第一阶段（MVP）请先采用模拟数据
- 数据字段参考通用的旅游网站（如携程）的产品数据字段

**模拟数据要求**：
- 机票数据：航班号、航空公司、出发/到达时间、价格、舱位、机型等
- 酒店数据：酒店名称、星级、位置、价格、设施、评分等
- 火车票数据：车次、出发/到达时间、座位类型、价格等
- 用车数据：车型、服务类型、价格、服务商等

**数据格式**：
- 模拟数据格式需与真实API格式保持一致
- 便于第二阶段无缝切换到真实API

**第二阶段计划**：
- 接入第三方差旅供应商API（如携程、去哪儿、飞猪等）
- 或自建产品数据库，定期同步供应商数据
- 实现实时产品数据获取和价格更新
```

---

#### 2. AI推荐算法细节完善
**位置**：需求文档 - 5.3.1 AI推荐算法详细设计

**当前状态**：✅ 已有基础内容，需要补充

**需要补充的内容**：
- [x] 输入参数（已有）
- [x] 推荐流程（已有）
- [ ] **Mock数据调用说明**（新增）
- [ ] **评分计算公式详细说明**（补充）
- [ ] **推荐原因生成规则**（补充）
- [ ] **异常情况处理**（补充）

**补充内容**：
```markdown
#### 5.3.1.1 Mock数据调用说明
**第一阶段（MVP）**：
- AI推荐算法调用Mock产品数据API
- Mock数据存储在Supabase数据库中（products_mock表）
- 根据出发地、目的地、日期等条件查询Mock数据

**Mock数据查询逻辑**：
1. 根据产品类型（flight/hotel/train/car）查询对应Mock表
2. 根据出发地、目的地、日期范围过滤数据
3. 返回符合条件的产品列表（模拟真实API响应格式）

**第二阶段**：
- 切换到真实差旅产品API
- 保持接口调用方式不变，仅更换数据源

#### 5.3.1.2 评分计算公式详细说明
**综合评分计算公式**：
```
综合评分 = 关键字匹配分(40%) + 性价比分(30%) + 便利性分(20%) + 合规性分(10%)
```

**各维度评分规则**：

1. **关键字匹配分（0-100分，权重40%）**：
   - 完全匹配用户选择的关键字：100分
   - 部分匹配：50-80分
   - 不匹配：0分
   - 多个关键字取平均值

2. **性价比分（0-100分，权重30%）**：
   - 价格 = 市场平均价：60分
   - 价格 < 市场平均价：60-100分（越低越高）
   - 价格 > 市场平均价：0-60分（越高越低）

3. **便利性分（0-100分，权重20%）**：
   - 时间因素：出发时间、到达时间、总时长
   - 位置因素：酒店位置、机场距离等
   - 根据用户偏好计算

4. **合规性分（0-100分，权重10%）**：
   - 符合差旅政策：100分
   - 部分符合：50-80分
   - 不符合：0分（会被过滤）

#### 5.3.1.3 推荐原因生成规则
**生成方式**：
- 使用AI大语言模型（如GPT-4、Claude）生成推荐原因
- 基于产品特征、用户关键字、评分结果生成个性化说明

**推荐原因模板**：
- "该方案[核心优势]，[价格优势]，[时间优势]，符合您的[关键字需求]"
- 每个方案生成50-100字的推荐说明

#### 5.3.1.4 异常情况处理
**无可用产品**：
- 返回空结果，提示用户调整搜索条件
- 提供"重新推荐"入口，引导用户修改关键字

**API调用失败**：
- 记录错误日志
- 返回友好错误提示
- 提供降级方案（如返回经典预订入口）

**推荐生成超时**：
- 设置10秒超时限制
- 超时后返回部分结果或错误提示
```

---

#### 3. 差旅产品API集成规范完善
**位置**：需求文档 - 5.3.2 差旅产品API集成

**当前状态**：✅ 已有基础内容，需要补充Mock数据规范

**需要补充的内容**：
- [ ] **Mock数据表结构设计**（新增）
- [ ] **Mock数据示例**（新增）
- [ ] **Mock数据API接口规范**（新增）
- [ ] **真实API对接计划**（补充）

**补充内容**：
```markdown
#### 5.3.2.1 Mock数据表结构设计
**数据库表设计**（在Supabase中创建）：

1. **flights_mock（机票Mock数据表）**
   - flight_no（航班号）
   - airline（航空公司）
   - origin（出发地）
   - destination（目的地）
   - departure_time（出发时间）
   - arrival_time（到达时间）
   - price（价格）
   - cabin_class（舱位：经济舱/商务舱/头等舱）
   - aircraft_type（机型）
   - duration（飞行时长）
   - stops（经停次数：0=直飞）

2. **hotels_mock（酒店Mock数据表）**
   - hotel_name（酒店名称）
   - star_rating（星级：3/4/5）
   - city（城市）
   - address（地址）
   - price_per_night（每晚价格）
   - facilities（设施：JSON数组）
   - rating（评分：0-5）
   - location_type（位置类型：市中心/机场附近等）

3. **trains_mock（火车票Mock数据表）**
   - train_no（车次）
   - origin（出发地）
   - destination（目的地）
   - departure_time（出发时间）
   - arrival_time（到达时间）
   - seat_type（座位类型：商务座/一等座/二等座）
   - price（价格）
   - duration（时长）

4. **cars_mock（用车Mock数据表）**
   - service_type（服务类型：专车/快车/经济型等）
   - car_type（车型）
   - price（价格）
   - provider（服务商）
   - capacity（载客数）

#### 5.3.2.2 Mock数据示例
**机票数据示例**：
```json
{
  "flight_no": "CA1234",
  "airline": "中国国际航空",
  "origin": "北京",
  "destination": "上海",
  "departure_time": "2024-12-20 08:00:00",
  "arrival_time": "2024-12-20 10:30:00",
  "price": 1200.00,
  "cabin_class": "经济舱",
  "aircraft_type": "A320",
  "duration": 150,
  "stops": 0
}
```

**酒店数据示例**：
```json
{
  "hotel_name": "北京王府井希尔顿酒店",
  "star_rating": 5,
  "city": "北京",
  "address": "北京市东城区王府井大街8号",
  "price_per_night": 800.00,
  "facilities": ["免费WiFi", "健身房", "商务中心", "含早餐"],
  "rating": 4.5,
  "location_type": "市中心"
}
```

#### 5.3.2.3 Mock数据API接口规范
**接口设计**（第一阶段使用Supabase查询，第二阶段切换为真实API）：

**查询机票接口**：
```
GET /api/products/flights
参数：
- origin: 出发地
- destination: 目的地
- departure_date: 出发日期
- return_date: 回程日期（可选）

响应格式：
{
  "code": 200,
  "data": [
    {
      "flight_no": "CA1234",
      "airline": "中国国际航空",
      ...
    }
  ]
}
```

**查询酒店接口**：
```
GET /api/products/hotels
参数：
- city: 城市
- check_in: 入住日期
- check_out: 退房日期

响应格式：类似机票接口
```

#### 5.3.2.4 真实API对接计划
**第二阶段对接方案**：
1. 评估第三方API供应商（携程、去哪儿、飞猪等）
2. 统一API接口封装层，便于切换
3. 实现API调用缓存机制，减少调用次数
4. 实现价格实时更新机制
```

---

#### 4. 审批流程详细规则完善
**位置**：需求文档 - 2.2.2 我的出差申请

**当前状态**：✅ 已有基础内容，需要补充模拟审批逻辑

**需要补充的内容**：
- [ ] **模拟审批逻辑详细说明**（新增）
- [ ] **审批人自动分配规则**（补充）
- [ ] **审批超时处理机制**（补充）

**补充内容**：
```markdown
#### 2.2.2.1 模拟审批逻辑详细说明
**第一阶段（MVP）模拟审批规则**：

1. **自动审批人分配**：
   - 系统自动查找申请人的部门经理作为一级审批人
   - 如果部门经理不存在，则分配给公司管理员
   - 使用Mock数据中的部门经理信息

2. **自动审批流程**：
   - 提交申请后，状态自动变为"审批中"
   - 24小时后自动通过（模拟审批人操作）
   - 或手动触发审批通过/拒绝（测试用）

3. **审批记录生成**：
   - 自动生成审批记录
   - 记录审批人、审批时间、审批结果
   - 审批意见自动填充："系统自动审批通过"

**第二阶段计划**：
- 对接真实审批系统
- 支持多级审批流程
- 支持审批人手动操作
- 支持审批超时提醒和升级机制
```

---

### 🟡 中优先级（建议补充，提升开发效率）

#### 5. 数据验证规则详细化
**位置**：需求文档 - 2.2.1 提交出差申请

**当前状态**：✅ 已有基础内容，需要补充后端验证

**需要补充的内容**：
- [ ] **后端数据验证规则**（新增）
- [ ] **字段格式验证详细说明**（补充）
- [ ] **业务规则验证**（补充）

**补充内容**：
```markdown
#### 2.2.1.2 后端数据验证规则
**服务器端验证**（Supabase RPC函数或Edge Functions）：

1. **必填字段验证**：
   - 出发地、目的地、出发日期、回程日期、出差原因、成本中心
   - 至少选择一种产品类型

2. **数据格式验证**：
   - 日期格式：YYYY-MM-DD
   - 日期范围：出发日期 >= 今天，回程日期 >= 出发日期
   - 出差天数：<= 30天（可配置）

3. **业务规则验证**：
   - 成本中心必须属于用户所在公司
   - 成本中心必须为激活状态
   - 用户必须有提交申请的权限

4. **数据长度验证**：
   - 出发地/目的地：2-50字符
   - 出差原因：10-500字符
```

---

#### 6. 权限控制详细说明
**位置**：需求文档 - 2.1.3 角色权限说明

**当前状态**：✅ 已有基础内容，需要补充数据访问权限

**需要补充的内容**：
- [ ] **数据访问权限矩阵**（新增）
- [ ] **RLS策略说明**（补充）

**补充内容**：
```markdown
#### 2.1.3.1 数据访问权限矩阵

| 数据/操作 | employee | approver | admin |
|---------|---------|---------|-------|
| 查看自己的申请单 | ✅ | ✅ | ✅ |
| 查看下属的申请单 | ❌ | ✅ | ✅ |
| 查看所有申请单 | ❌ | ❌ | ✅ |
| 提交申请单 | ✅ | ✅ | ✅ |
| 审批申请单 | ❌ | ✅ | ✅ |
| 查看自己的订单 | ✅ | ✅ | ✅ |
| 查看所有订单 | ❌ | ❌ | ✅ |
| 管理公司信息 | ❌ | ❌ | ✅ |
| 配置差旅政策 | ❌ | ❌ | ✅ |

#### 2.1.3.2 RLS策略说明
**Row Level Security策略**：
- 员工只能查看和操作自己的数据
- 审批人可以查看下属的数据
- 管理员可以查看所有数据
- 通过Supabase RLS实现数据隔离
```

---

#### 7. 错误处理机制完善
**位置**：需求文档 - 6.5 错误处理机制

**当前状态**：✅ 已有基础内容，需要补充具体错误码

**需要补充的内容**：
- [ ] **详细错误码列表**（新增）
- [ ] **错误处理流程图**（新增）
- [ ] **错误日志记录规范**（补充）

**补充内容**：
```markdown
#### 6.5.1 详细错误码列表

**网络错误（1000-1999）**：
- 1001: API请求超时
- 1002: 网络连接失败
- 1003: 服务器无响应

**业务逻辑错误（2000-2999）**：
- 2001: 出差申请单不存在
- 2002: 申请单状态不允许此操作
- 2003: 审批流程异常
- 2004: AI推荐生成失败

**数据验证错误（3000-3999）**：
- 3001: 必填字段缺失
- 3002: 日期格式错误
- 3003: 日期范围无效
- 3004: 成本中心不存在或已禁用

**权限相关错误（4000-4999）**：
- 4001: 无权限访问此资源
- 4002: 无权限执行此操作
- 4003: 用户未登录或token过期

**系统内部错误（5000-5999）**：
- 5001: 数据库连接失败
- 5002: 单号生成失败
- 5003: 系统内部异常

#### 6.5.2 错误处理流程
```
用户操作
  ↓
前端验证（基础验证）
  ↓
API调用
  ↓
后端验证（完整验证）
  ↓
业务逻辑处理
  ↓
成功 → 返回结果
失败 → 返回错误码和错误信息
  ↓
前端显示友好错误提示
```

#### 6.5.3 错误日志记录规范
**记录内容**：
- 错误码、错误信息
- 用户ID、操作时间
- 请求参数、堆栈信息
- 错误级别（INFO/WARN/ERROR）

**存储位置**：
- Supabase数据库（error_logs表）
- 或第三方日志服务（如Sentry）
```

---

### 🟢 低优先级（可选补充，优化体验）

#### 8. 用户体验细节
**位置**：需求文档 - 6.4 用户体验要求

**需要补充的内容**：
- [ ] 加载状态提示的具体样式说明
- [ ] 空状态页面设计规范
- [ ] 操作确认弹窗规则

#### 9. 测试用例章节
**位置**：需求文档 - 新增章节

**需要补充的内容**：
- [ ] 正常流程测试用例
- [ ] 异常流程测试用例
- [ ] 边界条件测试用例

#### 10. API接口文档章节
**位置**：需求文档 - 新增章节

**需要补充的内容**：
- [ ] 接口列表
- [ ] 请求/响应格式
- [ ] 认证方式
- [ ] 错误码定义

---

## 📝 新增章节建议

### 1. 开发阶段说明章节
**位置**：需求文档 - 第1章或第5章

**内容**：
- 第一阶段（MVP）使用模拟数据
- 第二阶段对接真实系统
- 数据迁移计划

### 2. Mock数据规范章节
**位置**：需求文档 - 第5章或新增附录

**内容**：
- Mock数据表结构
- Mock数据示例
- Mock数据API接口规范

### 3. 数据迁移方案章节
**位置**：数据库设计文档

**内容**：
- 初始数据迁移脚本
- 版本升级迁移方案
- 数据备份恢复流程

---

## ✅ 优化内容汇总

### 必须补充（高优先级）
1. ✅ **模拟数据使用说明**（企业组织架构 + 差旅产品数据）
2. ✅ **AI推荐算法Mock数据调用说明**
3. ✅ **差旅产品Mock数据表结构设计**
4. ✅ **审批流程模拟逻辑详细说明**
5. ✅ **用户搜索记录功能**（新增需求）⭐

### 建议补充（中优先级）
5. ✅ **后端数据验证规则**
6. ✅ **数据访问权限矩阵**
7. ✅ **详细错误码列表**

### 可选补充（低优先级）
8. ⚪ 用户体验细节
9. ⚪ 测试用例章节
10. ⚪ API接口文档章节

---

## 📋 待确认清单

请确认以下内容：

- [ ] 是否同意补充"模拟数据使用说明"？
- [ ] 是否同意补充"Mock数据表结构设计"？
- [ ] 是否同意补充"AI推荐算法详细说明"？
- [ ] 是否同意补充"审批流程模拟逻辑"？
- [ ] 是否同意补充"后端数据验证规则"？
- [ ] 是否同意补充"数据访问权限矩阵"？
- [ ] 是否同意补充"详细错误码列表"？
- [ ] 是否需要补充低优先级内容？

---

## 🆕 新增需求（用户搜索记录功能）

### 11. 用户经典预订搜索记录功能 ⭐ **新增需求**
**位置**：需求文档 - 2.3.1 经典预订

**需求说明**：
- 对每个用户所有的经典预订的搜索内容生成记录保存
- 记录用户搜索行为，分析用户需求和兴趣爱好
- 为AI推荐算法提供用户偏好数据

**需要补充的内容**：
- [ ] **搜索记录功能说明**（新增）
- [ ] **搜索记录数据表设计**（新增）
- [ ] **搜索记录数据结构**（新增）
- [ ] **搜索记录应用场景**（新增）

**补充内容**：
```markdown
#### 2.3.1.1 用户搜索记录功能

**功能描述**：
- 记录用户每次经典预订的搜索行为
- 保存搜索条件、搜索时间、产品类型等信息
- 用于分析用户偏好，优化AI推荐算法

**记录内容**：
- 用户ID
- 产品类型（flight/hotel/train/car）
- 搜索条件（出发地、目的地、日期等）
- 搜索时间
- 是否生成订单（搜索后是否实际预订）
- 搜索来源（独立搜索/从申请单跳转）

**应用场景**：
1. **用户偏好分析**：
   - 分析用户常去的城市
   - 分析用户偏好的出行时间
   - 分析用户偏好的产品类型

2. **AI推荐优化**：
   - 根据历史搜索记录优化推荐算法
   - 个性化推荐方案
   - 预测用户需求

3. **数据统计**：
   - 热门目的地统计
   - 出行时间分布统计
   - 产品类型偏好统计

**隐私保护**：
- 搜索记录仅用于系统内部分析和推荐优化
- 用户可查看自己的搜索历史
- 支持删除个人搜索记录
```

---

## 🚀 下一步行动

1. **等待确认**：请确认上述优化内容
2. **统一更新**：确认后统一更新到相关文档
3. **版本标记**：更新后标记文档版本号

---

**创建人**：AI Assistant  
**创建日期**：2024-12-19  
**状态**：待确认
