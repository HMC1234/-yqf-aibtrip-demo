# ğŸ“‹ è®¢å•æ¥æºä¿¡æ¯å±•ç¤ºåŠŸèƒ½

**å¼€å‘æ—¥æœŸ**ï¼š2024-12-19  
**åŠŸèƒ½æè¿°**ï¼šåœ¨"æˆ‘çš„è®¢å•"è¯¦æƒ…é¡µé¢å±•ç¤ºè®¢å•çš„æ¥æºä¿¡æ¯

---

## ğŸ“‹ åŠŸèƒ½éœ€æ±‚

### éœ€æ±‚æè¿°

åœ¨"æˆ‘çš„è®¢å•"ä¸­ï¼Œç‚¹å‡»è¿›å…¥æŸå¼ è®¢å•çš„è®¢å•è¯¦æƒ…ï¼Œå±•ç¤ºç”Ÿæˆè¿™å¼ è®¢å•çš„æ¥æºï¼š

1. **å¦‚æœè®¢å•æ¥è‡ªAIæ™ºèƒ½æ¨è**ï¼š
   - å±•ç¤ºAIæ™ºèƒ½æ¨èå·ï¼ˆ`recommendation_no`ï¼‰
   - å±•ç¤ºè¿™ä¸ªæ™ºèƒ½æ¨èå·å¯¹åº”çš„å‡ºå·®ç”³è¯·å•å·ï¼ˆå¦‚æœæœ‰ï¼‰
   - å‡ºå·®ç”³è¯·å•å·å¯ä»¥ç‚¹å‡»è·³è½¬åˆ°ç”³è¯·å•è¯¦æƒ…é¡µ

2. **å¦‚æœè®¢å•æ¥è‡ªç»å…¸æœç´¢**ï¼š
   - å±•ç¤ºä¸‹å•æ¥æºçš„æœç´¢è®°å½•å·ï¼ˆæœç´¢è®°å½•IDçš„ç®€åŒ–æ˜¾ç¤ºï¼‰

---

## âœ… å®ç°å†…å®¹

### 1. æ•°æ®ç»“æ„æ‰©å±• âœ…

**æ–°å¢æ¥å£**ï¼š
```typescript
interface OrderSource {
  type: 'ai_recommendation' | 'classic'
  recommendationNo?: string      // AIæ¨èå•å·
  travelRequestNo?: string       // å‡ºå·®ç”³è¯·å•å·
  searchRecordId?: string        // æœç´¢è®°å½•IDï¼ˆç®€åŒ–æ˜¾ç¤ºï¼‰
}
```

**è®¢å•æ¥å£æ‰©å±•**ï¼š
```typescript
interface Order {
  // ... ç°æœ‰å­—æ®µ
  ai_recommendation_id?: string  // AIæ¨èID
  travel_request_id?: string     // å‡ºå·®ç”³è¯·å•ID
}
```

---

### 2. æ•°æ®åŠ è½½é€»è¾‘ âœ…

**è®¢å•è¯¦æƒ…é¡µé¢**ï¼ˆ`OrderDetail.tsx`ï¼‰ï¼š

#### 2.1 åŠ è½½è®¢å•ä¿¡æ¯

```typescript
// åŠ è½½è®¢å•åŸºæœ¬ä¿¡æ¯
const { data: orderData } = await supabase
  .from('orders')
  .select('*')
  .eq('id', orderId)
  .single()
```

#### 2.2 æ ¹æ®è®¢å•æ¥æºåŠ è½½ç›¸å…³ä¿¡æ¯

**AIæ¨èæ¥æº**ï¼š
```typescript
if (orderData.booking_source === 'ai_recommendation' && orderData.ai_recommendation_id) {
  // 1. æŸ¥è¯¢AIæ¨èä¿¡æ¯
  const { data: recommendationData } = await supabase
    .from('ai_recommendations')
    .select('recommendation_no, travel_request_id')
    .eq('id', orderData.ai_recommendation_id)
    .single()

  // 2. å¦‚æœæœ‰travel_request_idï¼ŒæŸ¥è¯¢å‡ºå·®ç”³è¯·å•å·
  if (recommendationData?.travel_request_id) {
    const { data: requestData } = await supabase
      .from('travel_requests')
      .select('request_no')
      .eq('id', recommendationData.travel_request_id)
      .single()
    
    source.travelRequestNo = requestData?.request_no
  }
  
  source.recommendationNo = recommendationData?.recommendation_no
}
```

**ç»å…¸æœç´¢æ¥æº**ï¼š
```typescript
if (orderData.booking_source === 'classic') {
  // é€šè¿‡order_idæŸ¥è¯¢æœç´¢è®°å½•
  const { data: searchRecordData } = await supabase
    .from('search_records')
    .select('id')
    .eq('order_id', orderId)
    .single()

  // ä½¿ç”¨æœç´¢è®°å½•IDçš„å‰8ä½ä½œä¸ºæ˜¾ç¤ºï¼ˆæ›´å‹å¥½ï¼‰
  if (searchRecordData) {
    source.searchRecordId = searchRecordData.id.substring(0, 8).toUpperCase()
  }
}
```

---

### 3. UIå±•ç¤º âœ…

#### 3.1 è®¢å•æ¥æºæ ‡ç­¾

**æ˜¾ç¤º**ï¼š
```typescript
<Descriptions.Item label="é¢„è®¢æ¥æº">
  <Tag color={order.booking_source === 'ai_recommendation' ? 'purple' : 'blue'}>
    {order.booking_source === 'ai_recommendation' ? 'AIæ¨è' : 'ç»å…¸é¢„è®¢'}
  </Tag>
</Descriptions.Item>
```

---

#### 3.2 AIæ¨èæ¥æºä¿¡æ¯

**æ˜¾ç¤ºAIæ¨èå•å·**ï¼š
```typescript
{orderSource.type === 'ai_recommendation' && orderSource.recommendationNo && (
  <Descriptions.Item label="AIæ™ºèƒ½æ¨èå·">
    <span style={{ fontFamily: 'monospace' }}>
      {orderSource.recommendationNo}
    </span>
  </Descriptions.Item>
)}
```

**æ˜¾ç¤ºå‡ºå·®ç”³è¯·å•å·ï¼ˆå¯ç‚¹å‡»è·³è½¬ï¼‰**ï¼š
```typescript
{orderSource.travelRequestNo && (
  <Descriptions.Item label="æ¥æºå‡ºå·®ç”³è¯·å•å·">
    <Button
      type="link"
      style={{ padding: 0, height: 'auto', fontFamily: 'monospace' }}
      onClick={async () => {
        let requestId = order.travel_request_id
        
        // å¦‚æœæ²¡æœ‰ç›´æ¥çš„travel_request_idï¼Œé€šè¿‡AIæ¨èæŸ¥è¯¢
        if (!requestId && order.ai_recommendation_id) {
          const { data: recData } = await supabase
            .from('ai_recommendations')
            .select('travel_request_id')
            .eq('id', order.ai_recommendation_id)
            .single()
          
          if (recData?.travel_request_id) {
            requestId = recData.travel_request_id
          }
        }
        
        if (requestId) {
          navigate(`/travel-request/${requestId}`)
        } else {
          message.warning('æ— æ³•æ‰¾åˆ°å…³è”çš„å‡ºå·®ç”³è¯·å•')
        }
      }}
    >
      {orderSource.travelRequestNo}
    </Button>
  </Descriptions.Item>
)}
```

---

#### 3.3 ç»å…¸æœç´¢æ¥æºä¿¡æ¯

**æ˜¾ç¤ºæœç´¢è®°å½•å·**ï¼š
```typescript
{orderSource.type === 'classic' && orderSource.searchRecordId && (
  <Descriptions.Item label="æœç´¢è®°å½•å·">
    <span style={{ fontFamily: 'monospace' }}>
      SR-{orderSource.searchRecordId}
    </span>
  </Descriptions.Item>
)}
```

**è¯´æ˜**ï¼š
- æœç´¢è®°å½•IDæ ¼å¼ï¼š`SR-{UUIDå‰8ä½}`
- ä¾‹å¦‚ï¼š`SR-A1B2C3D4`
- ä½¿ç”¨UUIDçš„å‰8ä½æ˜¯ä¸ºäº†æ›´å‹å¥½çš„æ˜¾ç¤ºï¼Œé¿å…æ˜¾ç¤ºå®Œæ•´çš„36å­—ç¬¦UUID

---

## ğŸ“‹ æ•°æ®åº“å…³è”å…³ç³»

### è®¢å•è¡¨ï¼ˆordersï¼‰

```
orders
â”œâ”€â”€ id (UUID)
â”œâ”€â”€ order_no (VARCHAR)
â”œâ”€â”€ booking_source (VARCHAR)  # 'ai_recommendation' æˆ– 'classic'
â”œâ”€â”€ ai_recommendation_id (UUID, FK â†’ ai_recommendations.id)
â”œâ”€â”€ travel_request_id (UUID, FK â†’ travel_requests.id)
â””â”€â”€ ...
```

### AIæ¨èè¡¨ï¼ˆai_recommendationsï¼‰

```
ai_recommendations
â”œâ”€â”€ id (UUID)
â”œâ”€â”€ recommendation_no (VARCHAR)  # AIæ¨èå•å·
â”œâ”€â”€ travel_request_id (UUID, FK â†’ travel_requests.id)
â””â”€â”€ ...
```

### å‡ºå·®ç”³è¯·å•è¡¨ï¼ˆtravel_requestsï¼‰

```
travel_requests
â”œâ”€â”€ id (UUID)
â”œâ”€â”€ request_no (VARCHAR)  # ç”³è¯·å•å·
â””â”€â”€ ...
```

### æœç´¢è®°å½•è¡¨ï¼ˆsearch_recordsï¼‰

```
search_records
â”œâ”€â”€ id (UUID)  # æœç´¢è®°å½•IDï¼ˆæ²¡æœ‰å•ç‹¬çš„search_record_noå­—æ®µï¼‰
â”œâ”€â”€ order_id (UUID, FK â†’ orders.id)
â””â”€â”€ ...
```

---

## ğŸ”„ æ•°æ®æµ

### AIæ¨èè®¢å•æµç¨‹

```
ç”¨æˆ· â†’ AIæ¨èè¯¦æƒ…é¡µ â†’ ä¸€é”®é¢„è®¢ â†’ åˆ›å»ºè®¢å•
                         â†“
              orders.ai_recommendation_id = AIæ¨èID
                         â†“
              è®¢å•è¯¦æƒ…é¡µåŠ è½½æ—¶ï¼š
              1. æŸ¥è¯¢ ai_recommendations è·å– recommendation_no
              2. æŸ¥è¯¢ travel_requests è·å– request_no
                         â†“
              å±•ç¤ºï¼šAIæ¨èå•å· + å‡ºå·®ç”³è¯·å•å·
```

### ç»å…¸æœç´¢è®¢å•æµç¨‹

```
ç”¨æˆ· â†’ ç»å…¸æœç´¢ â†’ äº§å“åˆ—è¡¨ â†’ ç¡®è®¤é¢„è®¢ â†’ åˆ›å»ºè®¢å•
                                           â†“
                            orders.booking_source = 'classic'
                                           â†“
                                è®¢å•è¯¦æƒ…é¡µåŠ è½½æ—¶ï¼š
                                æŸ¥è¯¢ search_records é€šè¿‡ order_id
                                           â†“
                                å±•ç¤ºï¼šæœç´¢è®°å½•å·ï¼ˆSR-{UUIDå‰8ä½}ï¼‰
```

---

## âœ… åŠŸèƒ½å®Œæˆæƒ…å†µ

- âœ… è®¢å•è¯¦æƒ…é¡µé¢æ‰©å±•æ¥å£å®šä¹‰
- âœ… åŠ è½½è®¢å•æ¥æºä¿¡æ¯é€»è¾‘
- âœ… AIæ¨èæ¥æºä¿¡æ¯å±•ç¤ºï¼ˆæ¨èå•å· + ç”³è¯·å•å·ï¼‰
- âœ… ç»å…¸æœç´¢æ¥æºä¿¡æ¯å±•ç¤ºï¼ˆæœç´¢è®°å½•å·ï¼‰
- âœ… å‡ºå·®ç”³è¯·å•å·ç‚¹å‡»è·³è½¬åŠŸèƒ½
- âœ… é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µå¤„ç†

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. AIæ¨èè®¢å•æµ‹è¯•

1. **åˆ›å»ºAIæ¨èè®¢å•**
   - ä»AIæ¨èè¯¦æƒ…é¡µä¸€é”®é¢„è®¢
   - åˆ›å»ºè®¢å•åï¼Œè¿›å…¥è®¢å•è¯¦æƒ…é¡µ
   - **éªŒè¯**ï¼š
     - âœ… æ˜¾ç¤º"AIæ¨è"æ ‡ç­¾
     - âœ… æ˜¾ç¤ºAIæ™ºèƒ½æ¨èå·
     - âœ… å¦‚æœæœ‰å…³è”ç”³è¯·å•ï¼Œæ˜¾ç¤ºå‡ºå·®ç”³è¯·å•å·
     - âœ… ç‚¹å‡»ç”³è¯·å•å·å¯ä»¥è·³è½¬åˆ°ç”³è¯·å•è¯¦æƒ…é¡µ

2. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**
   - AIæ¨èæ²¡æœ‰å…³è”ç”³è¯·å•çš„æƒ…å†µ
   - **éªŒè¯**ï¼šåªæ˜¾ç¤ºAIæ¨èå•å·ï¼Œä¸æ˜¾ç¤ºç”³è¯·å•å·

---

### 2. ç»å…¸æœç´¢è®¢å•æµ‹è¯•

1. **åˆ›å»ºç»å…¸æœç´¢è®¢å•**
   - ä»ç»å…¸æœç´¢ â†’ äº§å“åˆ—è¡¨ â†’ ç¡®è®¤é¢„è®¢
   - åˆ›å»ºè®¢å•åï¼Œè¿›å…¥è®¢å•è¯¦æƒ…é¡µ
   - **éªŒè¯**ï¼š
     - âœ… æ˜¾ç¤º"ç»å…¸é¢„è®¢"æ ‡ç­¾
     - âœ… æ˜¾ç¤ºæœç´¢è®°å½•å·ï¼ˆæ ¼å¼ï¼šSR-{8ä½å­—ç¬¦}ï¼‰

2. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**
   - å¦‚æœæœç´¢è®°å½•ä¸å­˜åœ¨ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
   - **éªŒè¯**ï¼šä¸æ˜¾ç¤ºæœç´¢è®°å½•å·ï¼Œä½†ä¸å½±å“å…¶ä»–ä¿¡æ¯æ˜¾ç¤º

---

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `src/pages/Booking/OrderDetail.tsx`

**ä¸»è¦ä¿®æ”¹**ï¼š
- âœ… æ‰©å±•`Order`æ¥å£ï¼Œæ·»åŠ `ai_recommendation_id`å’Œ`travel_request_id`å­—æ®µ
- âœ… æ–°å¢`OrderSource`æ¥å£å®šä¹‰è®¢å•æ¥æºä¿¡æ¯
- âœ… æ–°å¢`orderSource`çŠ¶æ€å­˜å‚¨è®¢å•æ¥æºä¿¡æ¯
- âœ… æ‰©å±•`loadOrder`å‡½æ•°ï¼Œæ ¹æ®è®¢å•æ¥æºåŠ è½½ç›¸å…³ä¿¡æ¯
- âœ… åœ¨UIä¸­å±•ç¤ºè®¢å•æ¥æºä¿¡æ¯ï¼ˆAIæ¨èå•å·ã€ç”³è¯·å•å·ã€æœç´¢è®°å½•å·ï¼‰
- âœ… å®ç°ç”³è¯·å•å·ç‚¹å‡»è·³è½¬åŠŸèƒ½

---

## âœ… åŠŸèƒ½å®Œæˆ

**æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆï¼**

- âœ… è®¢å•è¯¦æƒ…é¡µé¢å¯ä»¥å±•ç¤ºè®¢å•æ¥æºä¿¡æ¯
- âœ… AIæ¨èè®¢å•æ˜¾ç¤ºæ¨èå•å·å’Œç”³è¯·å•å·
- âœ… ç»å…¸æœç´¢è®¢å•æ˜¾ç¤ºæœç´¢è®°å½•å·
- âœ… æ”¯æŒç‚¹å‡»ç”³è¯·å•å·è·³è½¬åˆ°ç”³è¯·å•è¯¦æƒ…é¡µ

**ç°åœ¨ç”¨æˆ·å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è®¢å•çš„æ¥æºä¿¡æ¯ï¼** ğŸš€

---

**å¼€å‘å®Œæˆæ—¥æœŸ**ï¼š2024-12-19  
**çŠ¶æ€**ï¼šâœ… **å·²å®Œæˆï¼Œå¯ä»¥æµ‹è¯•**

