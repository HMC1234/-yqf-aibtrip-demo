# 📋 订单关联出差申请单功能

**开发日期**：2024-12-19  
**功能描述**：在订单详情页面，允许用户为经典预订订单（未关联申请单）选择关联一个已存在的出差申请单

---

## 📋 功能需求

### 需求描述

如果订单号是通过经典搜索下单而来，且**没有关联出差申请单**，请增加一个字段，让用户选择关联一个已经存在的出差申请单。此功能是**用户可选的**。

**功能特点**：
- ✅ 仅在经典预订订单中显示
- ✅ 仅在订单未关联申请单时显示
- ✅ 用户可选功能（非必填）
- ✅ 显示用户的出差申请单列表供选择
- ✅ 选择后可以保存关联

---

## ✅ 实现内容

### 1. 状态管理 ✅

**新增状态**：
```typescript
const [travelRequests, setTravelRequests] = useState<TravelRequest[]>([])  // 用户的所有出差申请单
const [selectedRequestId, setSelectedRequestId] = useState<string | undefined>(undefined)  // 选中的申请单ID
const [linking, setLinking] = useState(false)  // 关联操作加载状态
```

---

### 2. 数据加载 ✅

#### 2.1 加载出差申请单列表

**时机**：
- 当订单是经典预订时，加载用户的出差申请单列表
- 无论订单是否已关联申请单，都会加载列表（用于显示已关联的申请单）

**实现**：
```typescript
const loadTravelRequests = async () => {
  try {
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return

    const { data, error } = await supabase
      .from('travel_requests')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false })

    if (error) {
      console.error('加载出差申请单失败:', error)
    } else {
      setTravelRequests((data as TravelRequest[]) || [])
    }
  } catch (error) {
    console.error('加载出差申请单失败:', error)
  }
}
```

**调用时机**：
- 在`loadOrder`函数中，如果订单是经典预订，调用`loadTravelRequests()`

---

### 3. 关联申请单功能 ✅

#### 3.1 保存关联

**实现**：
```typescript
const handleLinkTravelRequest = async () => {
  if (!selectedRequestId) {
    message.warning('请选择一个出差申请单')
    return
  }

  if (!order) return

  setLinking(true)
  try {
    const { error } = await supabase
      .from('orders')
      .update({ travel_request_id: selectedRequestId })
      .eq('id', order.id)

    if (error) {
      message.error('关联失败：' + error.message)
      return
    }

    message.success('关联成功！')
    
    // 重新加载订单信息
    await loadOrder(order.id)
    
    // 清空选择
    setSelectedRequestId(undefined)
  } catch (error: any) {
    message.error('关联失败：' + error.message)
  } finally {
    setLinking(false)
  }
}
```

**功能说明**：
- ✅ 验证是否选择了申请单
- ✅ 更新订单的`travel_request_id`字段
- ✅ 成功后重新加载订单信息
- ✅ 清空选择状态
- ✅ 错误处理和用户提示

---

### 4. UI展示 ✅

#### 4.1 关联申请单选择框（未关联时显示）

**显示条件**：
- `orderSource.type === 'classic'`（经典预订）
- `!order.travel_request_id`（未关联申请单）

**实现**：
```typescript
{orderSource.type === 'classic' && !order.travel_request_id && (
  <Descriptions.Item label="关联出差申请单" span={2}>
    <Space direction="vertical" style={{ width: '100%' }}>
      <Select
        placeholder="选择要关联的出差申请单（可选）"
        style={{ width: '100%', maxWidth: 500 }}
        showSearch
        value={selectedRequestId}
        onChange={setSelectedRequestId}
        optionFilterProp="label"
        filterOption={(input, option) =>
          (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
        }
        options={travelRequests.map(req => ({
          value: req.id,
          label: `${req.request_no} - ${req.origin} → ${req.destination} (${new Date(req.departure_date).toLocaleDateString()})`,
        }))}
        notFoundContent={travelRequests.length === 0 ? '暂无可关联的出差申请单' : undefined}
      />
      {selectedRequestId && (
        <Button
          type="primary"
          icon={<LinkOutlined />}
          onClick={handleLinkTravelRequest}
          loading={linking}
        >
          确认关联
        </Button>
      )}
    </Space>
  </Descriptions.Item>
)}
```

**功能特点**：
- ✅ 下拉选择框，支持搜索
- ✅ 显示申请单号、行程和出发日期
- ✅ 只有选择了申请单后才显示"确认关联"按钮
- ✅ 如果用户没有申请单，显示提示信息

---

#### 4.2 已关联申请单显示（已关联时显示）

**显示条件**：
- `order.travel_request_id`存在
- `orderSource.type === 'classic'`（经典预订）

**实现**：
```typescript
{order.travel_request_id && orderSource && orderSource.type === 'classic' && (
  <Descriptions.Item label="关联出差申请单">
    <Button
      type="link"
      style={{ padding: 0, height: 'auto', fontFamily: 'monospace' }}
      onClick={() => navigate(`/travel-request/${order.travel_request_id}`)}
    >
      {(() => {
        const request = travelRequests.find(r => r.id === order.travel_request_id)
        return request?.request_no || '加载中...'
      })()}
    </Button>
  </Descriptions.Item>
)}
```

**功能特点**：
- ✅ 显示申请单号（可点击跳转）
- ✅ 点击跳转到申请单详情页
- ✅ 如果申请单数据未加载完成，显示"加载中..."

---

#### 4.3 已关联申请单号加载

**优化**：
在`loadOrder`函数中，如果经典预订订单已经关联了申请单，也会查询申请单号：

```typescript
// 如果是经典预订，加载用户的申请单列表（用于关联）
if (orderData.booking_source === 'classic') {
  loadTravelRequests()
  
  // 如果已经有关联申请单，也需要查询申请单号用于显示
  if (orderData.travel_request_id) {
    const { data: requestData } = await supabase
      .from('travel_requests')
      .select('request_no')
      .eq('id', orderData.travel_request_id)
      .single()
    
    if (requestData) {
      source.travelRequestNo = requestData.request_no
    }
  }
}
```

---

## 📋 数据流程

### 关联流程

```
用户打开订单详情页
    ↓
检查订单来源（经典预订）
    ↓
检查是否已关联申请单
    ↓
【未关联】加载用户的所有申请单列表
    ↓
显示选择框供用户选择
    ↓
用户选择申请单
    ↓
点击"确认关联"按钮
    ↓
更新订单的 travel_request_id
    ↓
重新加载订单信息
    ↓
显示已关联的申请单号（可点击跳转）
```

---

## ✅ 功能完成情况

- ✅ 添加状态管理（申请单列表、选中状态、加载状态）
- ✅ 实现加载用户申请单列表功能
- ✅ 实现关联申请单功能（保存关联）
- ✅ 实现UI展示（选择框、确认按钮）
- ✅ 实现已关联申请单显示（可点击跳转）
- ✅ 实现关联后重新加载订单信息
- ✅ 实现错误处理和用户提示

---

## 🧪 测试建议

### 1. 基本功能测试

1. **打开经典预订订单详情页（未关联申请单）**
   - 验证：显示"关联出差申请单"选择框
   - 验证：选择框中显示用户的申请单列表
   - 验证：选择框支持搜索过滤

2. **选择申请单并关联**
   - 选择一个申请单
   - 点击"确认关联"按钮
   - 验证：显示"关联成功！"提示
   - 验证：订单详情页重新加载
   - 验证：显示已关联的申请单号（可点击）

3. **点击已关联的申请单号**
   - 验证：跳转到申请单详情页

---

### 2. 边界情况测试

1. **用户没有申请单**
   - 验证：选择框显示"暂无可关联的出差申请单"

2. **关联失败**
   - 模拟网络错误
   - 验证：显示错误提示信息

3. **已关联申请单的订单**
   - 打开已关联申请单的经典预订订单
   - 验证：不显示选择框
   - 验证：显示已关联的申请单号（可点击跳转）

---

### 3. 用户体验测试

1. **选择框显示信息**
   - 验证：显示申请单号、行程、出发日期
   - 验证：信息清晰易读

2. **操作流程**
   - 验证：操作流程顺畅
   - 验证：反馈及时（加载状态、成功/失败提示）

---

## 📋 修改的文件

### 1. `src/pages/Booking/OrderDetail.tsx`

**主要修改**：
- ✅ 导入`Select`、`Space`组件和`TravelRequest`类型
- ✅ 导入`LinkOutlined`图标
- ✅ 新增状态：`travelRequests`、`selectedRequestId`、`linking`
- ✅ 新增`loadTravelRequests`函数加载申请单列表
- ✅ 新增`handleLinkTravelRequest`函数保存关联
- ✅ 在`loadOrder`中调用`loadTravelRequests`
- ✅ 添加UI展示：选择框和确认按钮（未关联时）
- ✅ 添加UI展示：已关联申请单号（已关联时）

---

## ✅ 功能完成

**所有功能已完成！**

- ✅ 经典预订订单（未关联申请单）可以关联出差申请单
- ✅ 用户可以选择自己已存在的出差申请单进行关联
- ✅ 关联后显示申请单号，可点击跳转到申请单详情页
- ✅ 功能是用户可选的，不会强制关联

**现在用户可以方便地关联订单和出差申请单了！** 🚀

---

**开发完成日期**：2024-12-19  
**状态**：✅ **已完成，可以测试**

