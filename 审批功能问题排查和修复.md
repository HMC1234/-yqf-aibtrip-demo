# 审批功能问题排查和修复

## 问题描述
用户反馈：打开页面时，审批相关的功能都没有了。

## 问题分析

### 1. 代码检查
✅ **代码还在**：审批功能的代码在以下文件中都存在：
- `src/pages/TravelRequest/RequestList.tsx` - 列表页审批按钮
- `src/pages/TravelRequest/RequestDetail.tsx` - 详情页审批按钮
- `src/pages/Profile/Profile.tsx` - 个人中心审批权限设置

### 2. 可能的原因

#### 原因1：数据库字段不存在
- 如果数据库中 `users` 表没有 `can_approve` 字段，权限检查会失败
- `canApprove` 状态会保持为 `false`
- 导致审批按钮不显示

#### 原因2：用户权限未设置
- 用户的 `can_approve` 字段可能是 `null` 或 `false`
- 需要设置为 `true` 才能看到审批按钮

#### 原因3：权限检查逻辑问题
- 权限加载可能失败，但没有错误提示
- 需要在控制台查看是否有错误信息

## 解决方案

### 步骤1：检查数据库字段

请在 Supabase SQL Editor 中执行以下查询，检查字段是否存在：

```sql
-- 检查 can_approve 字段是否存在
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'users' AND column_name = 'can_approve';
```

**如果查询结果为空**，说明字段不存在，需要执行以下SQL：

```sql
-- 添加 can_approve 字段
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS can_approve BOOLEAN DEFAULT true;

-- 为所有现有用户设置默认值
UPDATE users 
SET can_approve = true 
WHERE can_approve IS NULL;

-- 确保 test@example.com 用户有审批权限
UPDATE users 
SET can_approve = true
WHERE email = 'test@example.com';
```

### 步骤2：检查用户权限

执行以下查询，检查当前用户的权限：

```sql
-- 检查当前用户的审批权限
SELECT 
    email,
    can_approve,
    CASE 
        WHEN can_approve = true THEN '✅ 有权限'
        WHEN can_approve = false THEN '❌ 无权限'
        ELSE '⚠️ 未设置（NULL）'
    END AS 权限状态
FROM users
WHERE email = 'test@example.com';
```

### 步骤3：使用一键设置脚本

如果字段不存在或未设置，执行 `一键设置审批权限.sql` 脚本：

1. 打开 Supabase Dashboard
2. 进入 SQL Editor
3. 复制 `一键设置审批权限.sql` 的内容
4. 执行脚本
5. 查看验证结果，应该显示 "✅ 有权限"

### 步骤4：刷新页面

执行完SQL后：
1. **等待 10-30 秒**（让 Supabase schema cache 刷新）
2. **刷新浏览器页面**（按 F5 或 Ctrl+R）
3. **重新登录**（如果需要）

### 步骤5：检查控制台

打开浏览器开发者工具（F12），查看 Console 是否有错误：

- 如果看到 "can_approve 字段可能不存在" - 说明字段不存在
- 如果看到 "加载审批权限失败" - 检查网络或数据库连接
- 如果看到 "用户审批权限加载成功" - 说明权限加载正常

### 步骤6：验证功能

1. **检查个人中心**：
   - 进入"个人中心" → "个人信息"
   - 应该能看到"审批权限"字段（带开关）
   - 开关应该显示为"有权限"

2. **检查出差申请列表**：
   - 进入"出差申请" → "我的出差申请"
   - 找到状态为"待审批"的申请单
   - 应该能看到"审批"按钮

3. **检查申请单详情**：
   - 打开一个"待审批"状态的申请单详情
   - 在状态标签旁边应该能看到"审批"按钮

## 快速修复脚本

如果问题仍然存在，执行以下完整脚本：

```sql
-- ============================================
-- 完整修复脚本
-- ============================================

-- 1. 确保字段存在
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS can_approve BOOLEAN DEFAULT true;

-- 2. 添加字段注释
COMMENT ON COLUMN users.can_approve IS '是否可以审批出差申请单权限：true=有权限，false=无权限';

-- 3. 创建索引（优化查询）
CREATE INDEX IF NOT EXISTS idx_users_can_approve 
ON users(can_approve) 
WHERE can_approve = true;

-- 4. 设置所有用户的默认值
UPDATE users 
SET can_approve = true 
WHERE can_approve IS NULL;

-- 5. 确保 test@example.com 有权限
UPDATE users 
SET can_approve = true,
    updated_at = NOW()
WHERE email = 'test@example.com';

-- 6. 验证结果
SELECT 
    email,
    can_approve,
    CASE 
        WHEN can_approve = true THEN '✅ 有权限'
        WHEN can_approve = false THEN '❌ 无权限'
        ELSE '⚠️ 未设置（NULL）'
    END AS 权限状态,
    updated_at
FROM users
WHERE email = 'test@example.com';
```

## 常见问题

### Q1: 执行SQL后还是看不到审批按钮？
**A**: 
1. 等待 10-30 秒让 schema cache 刷新
2. 刷新浏览器页面
3. 如果还是不行，尝试重新登录
4. 检查控制台是否有错误信息

### Q2: 个人中心看不到审批权限字段？
**A**: 
1. 检查数据库字段是否存在（步骤1）
2. 检查控制台是否有错误
3. 确保执行了SQL脚本

### Q3: 审批按钮显示但点击没反应？
**A**: 
1. 检查控制台是否有错误
2. 确认申请单状态是"待审批"（pending）
3. 检查网络连接

## 验证清单

- [ ] 数据库字段 `can_approve` 已创建
- [ ] `test@example.com` 用户的 `can_approve` 为 `true`
- [ ] 控制台没有错误信息
- [ ] 个人中心能看到审批权限字段
- [ ] 个人中心的审批权限开关显示为"有权限"
- [ ] 出差申请列表能看到审批按钮（对于待审批的申请单）
- [ ] 申请单详情页能看到审批按钮（对于待审批的申请单）

## 如果问题仍然存在

1. **检查浏览器控制台**：
   - 按 F12 打开开发者工具
   - 查看 Console 标签页
   - 截图错误信息

2. **检查网络请求**：
   - 在 Network 标签页查看 `/rest/v1/users` 请求
   - 查看响应数据是否包含 `can_approve` 字段

3. **联系支持**：
   - 提供控制台错误信息
   - 提供网络请求截图
   - 说明执行了哪些SQL脚本

