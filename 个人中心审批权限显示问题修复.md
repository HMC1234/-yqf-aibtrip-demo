# 个人中心审批权限显示问题修复指南

## 🔍 问题描述

登录 `test@example.com` 账号后，在个人中心看不到"审批权限"字段。

## 📋 可能原因

1. **数据库字段不存在**：`users` 表中还没有 `can_approve` 字段
2. **用户数据加载失败**：前端无法从数据库加载用户信息
3. **字段值为 NULL**：虽然字段存在，但值为 `NULL`，导致显示异常

---

## ✅ 解决步骤

### 第一步：执行数据库脚本（必须）

在 **Supabase SQL Editor** 中执行以下脚本：

```sql
-- 1. 添加 can_approve 字段（如果不存在）
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS can_approve BOOLEAN DEFAULT true;

-- 2. 为所有现有用户设置默认值
UPDATE users 
SET can_approve = true 
WHERE can_approve IS NULL;

-- 3. 确保 test@example.com 用户有审批权限
UPDATE users 
SET can_approve = true,
    updated_at = NOW()
WHERE email = 'test@example.com';

-- 4. 验证设置结果
SELECT 
    email,
    can_approve,
    CASE 
        WHEN can_approve = true THEN '✅ 有权限'
        WHEN can_approve = false THEN '❌ 无权限'
        ELSE '⚠️ 未设置（NULL）'
    END AS 权限状态
FROM users
WHERE email = 'test@example.com';
```

**预期结果**：最后一条 SELECT 应该显示 `can_approve = true` 和 `✅ 有权限`

---

### 第二步：刷新浏览器并检查

1. **完全刷新浏览器页面**（按 Ctrl+F5 强制刷新）
2. **或者退出登录后重新登录**
3. **打开浏览器控制台**（按 F12 → Console）
4. **进入个人中心页面**
5. **查看控制台输出**，应该看到：
   ```
   正在加载用户数据，用户ID: [UUID]
   用户数据加载成功: { email: 'test@example.com', can_approve: true, hasCanApprove: true }
   ```

---

### 第三步：验证显示

1. 进入"个人中心" → "个人信息"标签页
2. 滚动到页面底部
3. 应该能看到"审批权限"字段，显示为：
   - **移动端**：在个人信息卡片中，带有开关控件
   - **桌面端**：在 `Descriptions` 组件中，带有开关控件

---

## 🐛 故障排查

### 问题 1：执行SQL后仍然看不到字段

**检查清单**：

1. ✅ **确认SQL执行成功**
   - 在 Supabase SQL Editor 中执行验证查询
   - 确认 `can_approve` 字段存在且值为 `true`

2. ✅ **检查浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Console 标签
   - 确认是否有"用户数据加载成功"的日志
   - 确认 `can_approve` 字段是否存在

3. ✅ **检查是否有错误信息**
   - 如果看到 "can_approve 字段不存在" 的错误，说明数据库字段还没有添加
   - 需要重新执行添加字段的SQL

### 问题 2：控制台显示错误

#### 错误：`column "can_approve" does not exist`
**原因**：数据库字段不存在
**解决**：
```sql
ALTER TABLE users ADD COLUMN can_approve BOOLEAN DEFAULT true;
```

#### 错误：`加载用户信息失败`
**原因**：可能是权限问题或网络问题
**解决**：
- 检查 Supabase 连接是否正常
- 检查 RLS 策略是否允许读取 `users` 表

### 问题 3：字段显示但开关无法操作

**可能原因**：`updatingApprovalPermission` 状态卡住了
**解决**：
- 刷新页面
- 检查控制台是否有更新权限的错误信息

---

## 📝 验证步骤

### 1. 数据库验证（SQL）

```sql
-- 检查字段是否存在
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'users' 
AND column_name = 'can_approve';

-- 检查用户权限
SELECT 
    email,
    can_approve,
    updated_at
FROM users
WHERE email = 'test@example.com';
```

**预期结果**：
- 第一条查询应该返回 `can_approve` 字段信息
- 第二条查询应该显示 `can_approve = true`

### 2. 前端验证（浏览器）

1. **打开控制台**（F12 → Console）
2. **进入个人中心页面**
3. **查看日志输出**，应该看到：
   ```
   正在加载用户数据，用户ID: [UUID]
   用户数据加载成功: { email: 'test@example.com', can_approve: true, hasCanApprove: true }
   ```

4. **检查页面显示**：
   - 在"个人信息"标签页中
   - 应该能看到"审批权限"字段
   - 开关应该显示为"有权限"状态

---

## 🎯 快速诊断命令

如果您想快速诊断问题，执行以下SQL：

```sql
-- 综合诊断脚本
SELECT 
    -- 检查字段是否存在
    EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = 'users' 
        AND column_name = 'can_approve'
    ) AS 字段是否存在,
    
    -- 检查用户是否存在
    EXISTS (
        SELECT 1 FROM users WHERE email = 'test@example.com'
    ) AS 用户是否存在,
    
    -- 检查用户权限
    (SELECT can_approve FROM users WHERE email = 'test@example.com') AS 当前权限值,
    
    -- 检查用户数据
    (SELECT COUNT(*) FROM users WHERE email = 'test@example.com') AS 用户记录数;
```

**预期结果**：
- `字段是否存在`: `true`
- `用户是否存在`: `true`
- `当前权限值`: `true`
- `用户记录数`: `1`

---

## 📞 如果问题仍然存在

如果按照以上步骤操作后仍然看不到审批权限字段，请提供：

1. **SQL执行结果截图**
   - 执行验证查询后的结果

2. **浏览器控制台信息**
   - 按 F12 → Console 标签
   - 截图显示用户数据加载的日志和错误信息

3. **页面截图**
   - 个人中心 → 个人信息标签页的完整截图

这样我可以进一步帮您诊断问题。

