name: Deploy to Tencent Cloud COS (New)

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:

env:
  REGION: ap-guangzhou
  BUCKET: yqf-aibtrip-demo-1387623418

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build
        env:
          CI: false

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¥ Install Tencent COS SDK
        run: |
          pip install --upgrade pip
          pip install cos-python-sdk-v5

      - name: ğŸš€ Deploy to Tencent COS
        env:
          SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
          BUCKET: ${{ secrets.TENCENT_BUCKET || env.BUCKET }}
          REGION: ${{ secrets.TENCENT_REGION || env.REGION }}
        run: |
          python3 << 'EOF'
import os
import sys
from pathlib import Path
from qcloud_cos import CosConfig, CosS3Client

# è·å–ç¯å¢ƒå˜é‡
secret_id = os.environ.get('SECRET_ID')
secret_key = os.environ.get('SECRET_KEY')
region = os.environ.get('REGION', 'ap-guangzhou')
bucket = os.environ.get('BUCKET')

print("=" * 60)
print("ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘ COS")
print("=" * 60)
print(f"å­˜å‚¨æ¡¶: {bucket}")
print(f"åœ°åŸŸ: {region}")
print()

# éªŒè¯é…ç½®
if not secret_id or not secret_key:
    print("âŒ é”™è¯¯: SecretId æˆ– SecretKey æœªé…ç½®")
    sys.exit(1)

if not bucket:
    print("âŒ é”™è¯¯: å­˜å‚¨æ¡¶åç§°æœªé…ç½®")
    sys.exit(1)

# åˆå§‹åŒ– COS å®¢æˆ·ç«¯
print("æ­£åœ¨åˆå§‹åŒ– COS å®¢æˆ·ç«¯...")
try:
    config = CosConfig(Region=region, SecretId=secret_id, SecretKey=secret_key)
    client = CosS3Client(config)
    print("âœ… COS å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
    print()
except Exception as e:
    print(f"âŒ COS å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: {e}")
    sys.exit(1)

# æ£€æŸ¥ build ç›®å½•
build_dir = Path('build')
if not build_dir.exists():
    print("âŒ é”™è¯¯: build ç›®å½•ä¸å­˜åœ¨")
    sys.exit(1)

# ä¸Šä¼  index.html
print("ğŸ“¤ ä¸Šä¼  index.html...")
index_file = build_dir / 'index.html'
if index_file.exists():
    try:
        response = client.upload_file(
            Bucket=bucket,
            LocalFilePath=str(index_file),
            Key='index.html'
        )
        print(f"âœ… index.html ä¸Šä¼ æˆåŠŸ (ETag: {response.get('ETag', 'N/A')})")
    except Exception as e:
        print(f"âŒ index.html ä¸Šä¼ å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
else:
    print("âŒ é”™è¯¯: build/index.html ä¸å­˜åœ¨")
    sys.exit(1)

# ä¸Šä¼  static ç›®å½•
static_dir = build_dir / 'static'
if static_dir.exists():
    print()
    print("ğŸ“¤ ä¸Šä¼  static ç›®å½•...")
    uploaded = 0
    failed = 0
    
    for file_path in static_dir.rglob('*'):
        if file_path.is_file():
            relative_path = file_path.relative_to(build_dir)
            key = str(relative_path).replace('\\', '/')
            
            try:
                response = client.upload_file(
                    Bucket=bucket,
                    LocalFilePath=str(file_path),
                    Key=key
                )
                uploaded += 1
                if uploaded % 20 == 0:
                    print(f"  å·²ä¸Šä¼  {uploaded} ä¸ªæ–‡ä»¶...")
            except Exception as e:
                print(f"  âŒ å¤±è´¥: {key} - {e}")
                failed += 1
    
    print()
    print(f"âœ… static ç›®å½•ä¸Šä¼ å®Œæˆ")
    print(f"   æˆåŠŸ: {uploaded} ä¸ªæ–‡ä»¶")
    if failed > 0:
        print(f"   å¤±è´¥: {failed} ä¸ªæ–‡ä»¶")
        sys.exit(1)
else:
    print("âš ï¸  è­¦å‘Š: static ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡")

# ä¸Šä¼  asset-manifest.json (å¦‚æœæœ‰)
manifest_file = build_dir / 'asset-manifest.json'
if manifest_file.exists():
    print()
    print("ğŸ“¤ ä¸Šä¼  asset-manifest.json...")
    try:
        response = client.upload_file(
            Bucket=bucket,
            LocalFilePath=str(manifest_file),
            Key='asset-manifest.json'
        )
        print("âœ… asset-manifest.json ä¸Šä¼ æˆåŠŸ")
    except Exception as e:
        print(f"âš ï¸  asset-manifest.json ä¸Šä¼ å¤±è´¥: {e}")

print()
print("=" * 60)
print("âœ… éƒ¨ç½²å®Œæˆï¼")
print("=" * 60)
print(f"ğŸŒ è®¿é—®åœ°å€: https://{bucket}.cos-website.{region}.myqcloud.com")
EOF

      - name: ğŸ“‹ Deployment Summary
        if: success()
        env:
          BUCKET: ${{ secrets.TENCENT_BUCKET || env.BUCKET }}
          REGION: ${{ secrets.TENCENT_REGION || env.REGION }}
          CDN_DOMAIN: ${{ secrets.TENCENT_CDN_DOMAIN }}
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“¦ å­˜å‚¨æ¡¶: $BUCKET"
          echo "ğŸ“ åœ°åŸŸ: $REGION"
          if [ -n "$CDN_DOMAIN" ]; then
            echo "ğŸŒ CDNåœ°å€: https://$CDN_DOMAIN"
          else
            echo "ğŸŒ COSåœ°å€: https://$BUCKET.cos-website.$REGION.myqcloud.com"
          fi

