# 加密问题排查指南

## 问题描述

在测试页面中，加密结果与预期不一致：
- **实际结果**：`t3Kf5FwfcznFNPgdLt63B4N3XzZJCZqZceKE1DHcYKk=`
- **预期结果**：`8Z3dZzqn05FmiuBLowExK0CAbs4TY2GorC2dDPVlsn/tP+VuJGePqIMv1uSaVErr`

## 可能的原因

### 1. 密钥或文本不匹配
- 检查是否使用了正确的测试密钥：`1234567890123456`
- 检查是否使用了正确的测试文本：`abcdefghigklmnopqrstuvwxyz0123456789`

### 2. 浏览器环境差异
- crypto-js在不同浏览器中可能有细微差异
- 确保使用最新版本的crypto-js

### 3. IV创建方式
- 确保IV是16字节的零向量
- 已添加`iv.sigBytes = 16`确保长度正确

## 排查步骤

### 步骤1：检查输入参数

在浏览器控制台中运行：

```javascript
// 检查密钥
const key = '1234567890123456';
console.log('密钥长度:', key.length); // 应该是16

// 检查文本
const text = 'abcdefghigklmnopqrstuvwxyz0123456789';
console.log('文本长度:', text.length); // 应该是36
```

### 步骤2：手动测试加密

在浏览器控制台中运行：

```javascript
import { YQFCrypto } from './lib/yqf-air/crypto';

const text = 'abcdefghigklmnopqrstuvwxyz0123456789';
const key = '1234567890123456';

const result = YQFCrypto.encrypt(text, key);
console.log('加密结果:', result);
console.log('预期结果:', '8Z3dZzqn05FmiuBLowExK0CAbs4TY2GorC2dDPVlsn/tP+VuJGePqIMv1uSaVErr');
console.log('是否匹配:', result === '8Z3dZzqn05FmiuBLowExK0CAbs4TY2GorC2dDPVlsn/tP+VuJGePqIMv1uSaVErr');
```

### 步骤3：检查crypto-js版本

```bash
npm list crypto-js
```

确保版本是 `^4.2.0`

### 步骤4：清除浏览器缓存

1. 清除浏览器缓存
2. 硬刷新页面（Ctrl+Shift+R 或 Cmd+Shift+R）
3. 重新测试

## 修复后的代码

已更新 `src/lib/yqf-air/crypto.ts`：

1. ✅ 确保IV长度为16字节（`iv.sigBytes = 16`）
2. ✅ 使用UTF-8解析密钥（`CryptoJS.enc.Utf8.parse(secretKey)`）
3. ✅ 使用toString()方法返回Base64编码结果
4. ✅ 添加调试信息（开发环境）

## 验证方法

### 方法1：使用测试脚本

```bash
node test-encryption.js
```

应该输出：
```
✅ 加密测试通过！加密实现正确。
```

### 方法2：使用测试页面

1. 访问：`http://localhost:3000/test/yqf-api`
2. 在"配置"标签页
3. 点击"使用文档示例测试"按钮
4. 查看结果是否匹配

### 方法3：浏览器控制台

打开浏览器开发者工具（F12），在控制台中：

```javascript
// 导入加密工具（需要根据实际路径调整）
const CryptoJS = require('crypto-js');

function encrypt(plainText, secretKey) {
  const iv = CryptoJS.lib.WordArray.create([0, 0, 0, 0]);
  iv.sigBytes = 16;
  const key = CryptoJS.enc.Utf8.parse(secretKey);
  const encrypted = CryptoJS.AES.encrypt(plainText, key, {
    iv: iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7,
  });
  return encrypted.toString();
}

const text = 'abcdefghigklmnopqrstuvwxyz0123456789';
const key = '1234567890123456';
const result = encrypt(text, key);
console.log('结果:', result);
console.log('预期:', '8Z3dZzqn05FmiuBLowExK0CAbs4TY2GorC2dDPVlsn/tP+VuJGePqIMv1uSaVErr');
```

## 如果问题仍然存在

1. **检查crypto-js版本**：确保使用 `^4.2.0`
2. **清除node_modules并重新安装**：
   ```bash
   rm -rf node_modules package-lock.json
   npm install
   ```
3. **检查浏览器控制台错误**：查看是否有JavaScript错误
4. **尝试不同的浏览器**：Chrome、Firefox、Edge等

## 当前实现

代码已更新为：
- ✅ 使用`WordArray.create([0, 0, 0, 0])`创建IV
- ✅ 显式设置`iv.sigBytes = 16`
- ✅ 使用`CryptoJS.enc.Utf8.parse()`解析密钥
- ✅ 使用`encrypted.toString()`返回结果

这些更改应该能确保在浏览器和Node.js环境中行为一致。

---

**提示**：如果问题仍然存在，请检查：
1. 测试时使用的密钥和文本是否正确
2. 浏览器控制台是否有错误信息
3. crypto-js是否正确加载

