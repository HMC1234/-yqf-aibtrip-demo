# 审批权限问题诊断和修复指南

## 🔍 问题描述

登录 `test@example.com` 账号后，无法看到"审批"按钮。

## 📋 问题可能原因

1. **数据库字段不存在**：`users` 表中还没有 `can_approve` 字段
2. **权限未设置**：`test@example.com` 用户的 `can_approve` 字段值为 `false` 或 `NULL`
3. **数据库迁移未执行**：还没有执行添加审批权限字段的SQL脚本

---

## ✅ 快速修复（推荐）

### 方法一：一键设置（最简单）

在 **Supabase SQL Editor** 中执行 `一键设置审批权限.sql` 脚本。

**执行步骤**：
1. 打开 Supabase Dashboard
2. 进入 **SQL Editor**
3. 复制 `一键设置审批权限.sql` 的全部内容
4. 粘贴到 SQL Editor 中
5. 点击 **"Run"** 执行
6. 查看执行结果，确认显示 "✅ 有权限"

---

### 方法二：分步执行

如果一键脚本有问题，可以分步执行：

#### 步骤 1：添加字段（如果还没有）

```sql
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS can_approve BOOLEAN DEFAULT true;
```

#### 步骤 2：检查当前状态

```sql
SELECT 
    email,
    can_approve,
    CASE 
        WHEN can_approve = true THEN '✅ 有权限'
        WHEN can_approve = false THEN '❌ 无权限'
        ELSE '⚠️ 未设置（NULL）'
    END AS 权限状态
FROM users
WHERE email = 'test@example.com';
```

#### 步骤 3：设置权限

```sql
UPDATE users 
SET can_approve = true,
    updated_at = NOW()
WHERE email = 'test@example.com';
```

#### 步骤 4：再次验证

```sql
SELECT 
    email,
    can_approve
FROM users
WHERE email = 'test@example.com';
```

**预期结果**：`can_approve` 应该显示为 `true` 或 `t`

---

## 🔄 设置后的操作

执行SQL脚本后，需要：

1. **刷新浏览器页面**（按 F5 或 Ctrl+R）
   - 前端会重新加载用户权限

2. **或者完全退出登录，然后重新登录**
   - 这会确保用户数据被重新加载

3. **检查浏览器控制台**（可选）
   - 按 F12 打开开发者工具
   - 切换到 "Console" 标签
   - 查看是否有权限加载的日志信息
   - 应该看到：`用户审批权限加载成功: { can_approve: true, hasPermission: true }`

---

## 🐛 故障排查

### 问题 1：执行SQL后仍然看不到按钮

**可能原因**：
- 前端代码还没有重新加载用户权限
- 浏览器缓存了旧的用户数据
- 申请单状态不是 `pending`（只有"待审批"状态的申请单才显示按钮）

**解决方法**：

1. **检查申请单状态**
   - 进入"出差申请" → "待审批"标签页
   - 确保有状态为"待审批"的申请单
   - 审批按钮只在"待审批"状态的申请单上显示

2. **完全退出并重新登录**
   - 点击右上角"个人中心" → 退出登录
   - 重新登录 `test@example.com`

3. **清除浏览器缓存**
   - Chrome: Ctrl+Shift+Delete → 清除缓存
   - 或使用隐私模式（Ctrl+Shift+N）重新登录

4. **检查浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Console 标签
   - 确认是否有权限加载的日志或错误信息

### 问题 2：SQL执行报错

#### 错误：`column "can_approve" does not exist`
**原因**：字段不存在
**解决**：先执行添加字段的SQL：
```sql
ALTER TABLE users ADD COLUMN can_approve BOOLEAN DEFAULT true;
```

#### 错误：`permission denied`
**原因**：权限不足
**解决**：确保在 Supabase SQL Editor 中执行，而不是在客户端代码中

### 问题 3：前端控制台显示错误

#### 错误：`加载审批权限失败: ... column "can_approve" does not exist`
**原因**：数据库字段不存在
**解决**：执行添加字段的SQL脚本

#### 错误：`未找到用户数据`
**原因**：`users` 表中没有该用户记录
**解决**：需要在 `users` 表中创建用户记录

---

## 📝 验证步骤

### 1. 验证数据库权限（SQL）

```sql
SELECT 
    email,
    can_approve,
    CASE 
        WHEN can_approve = true THEN '✅ 有权限'
        ELSE '❌ 无权限'
    END AS 状态
FROM users
WHERE email = 'test@example.com';
```

**预期结果**：显示 `can_approve = true`

### 2. 验证前端权限（浏览器）

1. 登录 `test@example.com`
2. 打开浏览器控制台（F12 → Console）
3. 进入"出差申请"页面
4. 查看控制台输出，应该看到：
   ```
   正在加载用户审批权限，用户ID: [UUID]
   用户审批权限加载成功: { can_approve: true, hasPermission: true }
   ```

### 3. 验证按钮显示

1. 进入"出差申请" → "我的出差申请"
2. 点击"待审批"标签页
3. **必须有状态为"待审批"的申请单**
4. 应该能看到"审批"按钮（在状态标签旁边）

### 4. 验证个人中心权限显示

1. 进入"个人中心" → "个人信息"标签页
2. 找到"审批权限"字段
3. 开关应该显示为"有权限"状态

---

## 🎯 快速诊断命令

如果您想快速诊断问题，执行以下SQL：

```sql
-- 诊断脚本：检查字段和权限
SELECT 
    -- 检查字段是否存在
    EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = 'users' 
        AND column_name = 'can_approve'
    ) AS 字段是否存在,
    
    -- 检查用户是否存在
    EXISTS (
        SELECT 1 FROM users WHERE email = 'test@example.com'
    ) AS 用户是否存在,
    
    -- 检查用户权限
    (SELECT can_approve FROM users WHERE email = 'test@example.com') AS 当前权限值;
```

**预期结果**：
- `字段是否存在`: `true`
- `用户是否存在`: `true`
- `当前权限值`: `true`

如果任何一项为 `false` 或 `NULL`，按照上面的方法修复。

---

## 📞 如果问题仍然存在

如果按照以上步骤操作后仍然看不到审批按钮，请提供：

1. **SQL执行结果截图**
   - 执行 `一键设置审批权限.sql` 后的结果

2. **浏览器控制台信息**
   - 按 F12 → Console 标签
   - 截图显示权限加载的日志

3. **申请单状态**
   - 确认是否有状态为 `pending` 的申请单

这样我可以进一步帮您诊断问题。

