# YQFAIBTRIP 一起飞智能商旅系统 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目背景

YQFAIBTRIP（一起飞智能商旅系统）是一个面向企业的SaaS差旅管理平台，支持多企业、多层级、多角色的差旅管理。系统核心特色是AI智能推荐功能，能够根据出差申请自动生成最优差旅方案，提升差旅管理效率和用户体验。

### 1.2 产品定位

- **目标用户**：企业员工、差旅管理员、审批人员
- **核心价值**：AI驱动的智能差旅推荐，简化差旅预订流程
- **技术栈**：前端 React，后端 Supabase

### 1.3 核心功能模块

1. 出差申请管理
2. 经典预订（传统搜索预订）
3. AI智能预订（对话式预订 + 智能推荐）
4. 个人中心
5. 审批流程管理

---

## 2. 功能需求详细说明

### 2.1 用户认证与个人中心

#### 2.1.1 用户登录

- **默认测试账号**：用户名 `test`，密码 `123456`
- 支持多企业注册使用
- 用户信息包括：公司名、部门、成本中心、个人信息

#### 2.1.2 个人中心功能

- 查看用户基本信息（公司、部门、成本中心）
- 查看所有出差申请单（按状态分类）
- 查看所有预订单
- 查看出行管理记录
- 查看所有AI推荐方案历史

#### 2.1.3 角色权限说明

**employee（员工）**：

- 提交出差申请
- 查看自己的申请和订单
- 使用AI预订功能
- 查看个人中心数据

**approver（审批人）**：

- 审批下属的出差申请
- 查看部门申请统计
- 查看待审批列表
- 审批历史记录

**admin（管理员）**：

- 管理公司信息
- 配置差旅政策
- 管理用户和部门
- 查看所有数据统计
- 系统配置管理

---

### 2.2 出差申请管理

#### 2.2.1 提交出差申请

**页面功能**：

- 出发地（必填）
- 目的地（必填）
- 出发日期（必填）
- 回程日期（必填）
- 出差原因（必填）
- 成本中心（必填）
- 需要预订的产品（多选）：
  - 机票
  - 酒店
  - 火车票
  - 用车

**业务规则**：

- 提交成功后生成出差申请单号
- **单号规则**：`BTRQ+JD+年月日时分秒+四位顺序号`
  - 示例：`BTRQ+JD+20241219143025+0001`

**数据验证规则**：

- **出发地/目的地**：
  
  - 必填，长度2-50字符
  - 支持城市名称或机场代码（如：北京、PEK）

- **日期验证**：
  
  - 出发日期 >= 今天
  - 回程日期 >= 出发日期
  - 日期格式：YYYY-MM-DD
  - 出差天数 <= 30天（可配置）

- **成本中心**：
  
  - 必填，必须属于用户所在公司
  - 必须为激活状态

- **产品选择**：
  
  - 至少选择一种产品类型
  - 支持多选

- **出差原因**：
  
  - 必填，长度10-500字符

#### 2.2.2 我的出差申请

**功能列表**：

- 已提交等待审批
- 审批中
- 审批完成
- 全部申请单

**审批流程**（模拟）：

1. 提交后状态：`已提交等待审批`
2. 进入审批流程：`审批中`
3. 审批完成：`审批完成`

**审批流程详细规则**：

- **审批人分配**：
  
  - 默认：部门经理作为一级审批人
  - 超过一定金额（可配置）：需要财务审批
  - 支持多级审批流程配置

- **审批时间**：
  
  - 开发阶段：24小时内无操作自动通过（模拟）
  - 生产环境：支持审批超时提醒和升级机制

- **审批状态流转**：
  
  ```
  pending（已提交等待审批）
    ↓
  approving（审批中）
    ↓
  approved（审批完成）或 rejected（已拒绝）
  ```

- **审批记录**：
  
  - 记录每次审批操作
  - 记录审批人、审批时间、审批意见
  - 支持审批历史查询

**申请单详情页**（审批完成后）：

- 显示申请单完整信息
- 提供两个预订入口：
  - **经典预订**：跳转到经典预订页面，自动填充申请单参数
  - **AI预订**：跳转到AI推荐流程

---

### 2.3 预订管理

#### 2.3.1 经典预订

**功能描述**：

- 支持独立搜索预订（无需出差申请单）
- 支持从出差申请单跳转（自动填充参数）
- 产品类型：机票、酒店、火车票、用车

**预订流程**：

1. 搜索页面（参考携程等平台）
2. 选择产品
3. 填写预订信息
4. 确认订单
5. 生成预订单

**业务规则**：

- **预订单号规则**：
  - 经典预订订单：`BK+TR+年月日时分秒+五位顺序号`
    - 示例：`BK+TR+20241219143025+00001`
  - AI推荐方案一键预订订单：`BK+AI+年月日时分秒+五位顺序号`
    - 示例：`BK+AI+20241219143025+00001`

#### 2.3.1.1 用户搜索记录功能

**功能描述**：
- 记录用户每次经典预订的搜索行为
- 保存搜索条件、搜索时间、产品类型等信息
- 用于分析用户偏好，优化AI推荐算法

**记录内容**：
- 用户ID
- 产品类型（flight/hotel/train/car）
- 搜索条件（出发地、目的地、日期、人数等）
- 搜索时间
- 是否生成订单（搜索后是否实际预订）
- 搜索来源（independent=独立搜索 / travel_request=从申请单跳转）
- 关联的出差申请单ID（如果从申请单跳转）

**应用场景**：
1. **用户偏好分析**：
   - 分析用户常去的城市（出发地、目的地）
   - 分析用户偏好的出行时间（工作日/周末、月份分布）
   - 分析用户偏好的产品类型（机票/酒店/火车票/用车）
   - 分析用户搜索频率和习惯

2. **AI推荐优化**：
   - 根据历史搜索记录优化推荐算法
   - 个性化推荐方案（基于用户常去城市、偏好时间等）
   - 预测用户需求（提前推荐用户可能需要的产品）
   - 智能填充搜索表单（记住用户常用搜索条件）

3. **数据统计与分析**：
   - 热门目的地统计
   - 出行时间分布统计
   - 产品类型偏好统计
   - 用户行为分析报告

**隐私保护**：
- 搜索记录仅用于系统内部分析和推荐优化
- 用户可查看自己的搜索历史
- 支持删除个人搜索记录
- 符合数据隐私保护规范

**数据存储**：
- 所有搜索记录存储在Supabase数据库（search_records表）
- 支持按用户、时间、产品类型等维度查询
- 定期清理过期数据（建议保留6-12个月）

#### 2.3.2 AI预订

**页面结构**（三个标签页）：

1. **智能对话预订**
2. **AI推荐方案**
3. **已审批出差申请列表**

##### 2.3.2.1 智能对话预订

**功能描述**：

- AI对话界面，引导用户完成差旅需求
- 默认引导问题：`我要出差`

**核心功能**：

1. **生成出差申请单**
   
   - 通过对话收集信息（出发地、目的地、日期、原因等）
   - 自动生成出差申请单
   - **单号规则**：`BTRQ+AI+年月日时分秒+四位顺序号`
   - 示例：`BTRQ+AI+20241219143025+0001`

2. **生成AI推荐方案**
   
   - 用户可直接在对话中输入需求
   - 或自动获取最近出差申请内容
   - 生成AI推荐方案
   - **单号规则**：`AIRD+AIC+年月日时分秒+五位顺序号`
   - 示例：`AIRD+AIC+20241219143025+00001`

##### 2.3.2.2 AI推荐方案列表

**功能描述**：

- 显示所有历史AI推荐方案
- 包括：
  - 从出差申请单生成的推荐方案
  - 从智能对话生成的推荐方案
- 点击方案进入详情页
- 详情页提供"一键预订"功能，根据AI智能推荐方案的预订生成的预订单，其预订单号命名规则为：BK+AI+年月日时分秒+五位顺序号

##### 2.3.2.3 已审批出差申请列表

**功能描述**：

- 显示所有已审批完成的出差申请单
- 点击进入申请单详情
- 详情页提供"经典预订"和"AI预订"入口

---

### 2.4 AI智能推荐方案

#### 2.4.1 推荐方案生成方式

**方式1：基于出差申请单自动推荐**

- 触发：从已审批出差申请单详情页点击"AI预订"
- 流程：
  1. 显示加载页面："正在根据您的出差申请，智能生成推荐方案"
  2. 后台执行：
     - A. 自动获取每个旅行产品数据
     - B. 自动核查公司差旅政策
     - C. 根据需求特征（最短时间/最优价格/最舒适）推荐3-5个方案
  3. 展示推荐方案（卡片式）
     - AI推荐单号
     - 核心关键字
     - 推荐原因说明
- **单号规则**：`AIRD+ZDT+年月日时分秒+五位顺序号`
  - 示例：`AIRD+ZDT+20241219143025+00001`

**方式2：智能对话生成推荐**

- 触发：在智能对话页面通过对话生成
- **单号规则**：`AIRD+AIC+年月日时分秒+五位顺序号`
  - 示例：`AIRD+AIC+20241219143025+00001`

#### 2.4.2 重新推荐功能

**功能描述**：

- 在推荐方案结果页提供"重新推荐"按钮
- 点击后弹出关键字选择页面

**关键字选项**（预设）：
**机票相关**：

- 选择大飞机
- 上午最低价
- 下午出发
- 直飞优先
- 经济舱
- 商务舱
- 头等舱
- 最短飞行时间
- 最低价格
- 特定航空公司

**酒店相关**：

- 五星级酒店
- 四星级酒店
- 市中心位置
- 机场附近
- 最低价格
- 最高评分
- 含早餐
- 免费WiFi
- 健身房
- 商务中心

**火车票相关**：

- 高铁优先
- 动车优先
- 最短时间
- 最低价格
- 商务座
- 一等座

**用车相关**：

- 经济型
- 舒适型
- 豪华型
- 7座商务车
- 专车服务

**业务规则**：

- 用户可选择多个关键字或自定义输入
- 根据"关键字 + 出差申请单"生成新推荐方案
- **单号规则**：
  - 基于申请单重新推荐：`AIRD+GXH+年月日时分秒+五位顺序号`
  - 基于对话重新推荐：`AIRD+GXC+年月日时分秒+五位顺序号`

#### 2.4.3 推荐方案详情页

**显示内容**：

- 推荐单号
- 推荐方案详情（3-5个方案卡片）
- 每个方案包含：
  - 核心关键字
  - 推荐原因说明
  - 方案内容（机票、酒店、火车票、用车等详细信息）
  - 价格信息
  - 政策符合度

**功能按钮**：

- **一键预订**：自动填充推荐方案参数，进入预订流程,根据AI智能推荐方案的预订生成的预订单，其预订单号命名规则为：BK+AI+年月日时分秒+五位顺序号
- **重新推荐**：生成新的推荐方案

---

### 2.5 数据存储要求

#### 2.5.1 必须存储的数据

- 所有出差申请单及详情
- 所有预订单及详情
- 所有AI推荐方案及详情
- 所有单号生成记录
- 用户信息
- 审批记录
- 对话记录（智能对话）

#### 2.5.2 数据存储平台

- 使用 Supabase 作为后端数据库
- 所有数据实时同步存储

---

## 3. 单号生成规则汇总

| 业务类型       | 单号规则                  | 示例                            |
| ---------- | --------------------- | ----------------------------- |
| 页面提交出差申请   | BTRQ+JD+年月日时分秒+四位顺序号  | BTRQ+JD+20241219143025+0001   |
| AI对话生成出差申请 | BTRQ+AI+年月日时分秒+四位顺序号  | BTRQ+AI+20241219143025+0001   |
| 经典预订订单     | BK+TR+年月日时分秒+五位顺序号    | BK+TR+20241219143025+00001    |
| AI推荐方案一键预订订单 | BK+AI+年月日时分秒+五位顺序号 | BK+AI+20241219143025+00001    |
| 申请单自动推荐    | AIRD+ZDT+年月日时分秒+五位顺序号 | AIRD+ZDT+20241219143025+00001 |
| 申请单重新推荐    | AIRD+GXH+年月日时分秒+五位顺序号 | AIRD+GXH+20241219143025+00001 |
| 对话生成推荐     | AIRD+AIC+年月日时分秒+五位顺序号 | AIRD+AIC+20241219143025+00001 |
| 对话重新推荐     | AIRD+GXC+年月日时分秒+五位顺序号 | AIRD+GXC+20241219143025+00001 |

**单号生成逻辑**：

- 年月日时分秒格式：`YYYYMMDDHHmmss`
- 顺序号：从0001/00001开始递增，每日重置或全局递增（根据业务需求）

---

## 4. 页面路由结构

```
/ (首页)
├── /dashboard (首页仪表板)
├── /profile (个人中心)
├── /travel-request
│   ├── /new (提交新申请)
│   └── /list (我的申请)
│       └── /:id (申请单详情)
├── /booking
│   ├── /classic (经典预订)
│   │   ├── /flight (机票)
│   │   ├── /hotel (酒店)
│   │   ├── /train (火车票)
│   │   └── /car (用车)
│   └── /ai (AI预订)
│       ├── /chat (智能对话)
│       ├── /recommendations (推荐方案列表)
│       └── /approved-requests (已审批申请列表)
├── /recommendation
│   └── /:id (推荐方案详情)
└── /order
    └── /:id (订单详情)
```

---

## 5. 技术实现要求

### 5.1 前端技术栈

- **框架**：React
- **状态管理**：Redux / Zustand / Context API
- **路由**：React Router
- **UI组件库**：Ant Design / Material-UI / Tailwind CSS
- **HTTP客户端**：Axios / Fetch
- **表单处理**：React Hook Form / Formik

### 5.2 后端技术栈

- **数据库**：Supabase (PostgreSQL)
- **认证**：Supabase Auth
- **实时数据**：Supabase Realtime
- **存储**：Supabase Storage（如需要）

### 5.3 AI集成要求

- AI对话功能需要集成大语言模型API（如OpenAI、Claude等）
- AI推荐算法需要调用差旅产品API和差旅政策API
- 推荐结果需要实时计算并存储

#### 5.3.1 AI推荐算法详细设计

**输入参数**：

- 出发地、目的地（城市名称或机场代码）
- 出发日期、回程日期
- 需要预订的产品类型（flight/hotel/train/car）
- 用户选择的关键字（可选，JSON数组）
- 公司差旅政策ID
- 用户ID（用于获取用户偏好）

**推荐流程**：

1. **数据获取阶段**：
   
   - 调用差旅产品API获取可用产品列表（或查询Mock数据）
   - 根据产品类型分别获取：机票航班、酒店列表、火车班次、用车服务

2. **政策验证阶段**：
   
   - 调用差旅政策API验证产品合规性
   - 过滤不符合政策的产品
   - 标记政策符合度

3. **评分计算阶段**：
   
   - 根据关键字匹配度计算基础分（0-100）
   - 根据价格计算性价比分
   - 根据时间计算便利性分
   - 根据政策符合度计算合规分
   - 综合评分 = 关键字匹配(40%) + 性价比(30%) + 便利性(20%) + 合规性(10%)

4. **方案生成阶段**：
   
   - 按综合评分排序
   - 选择Top 3-5个方案
   - 为每个方案生成推荐原因说明（AI生成）

5. **结果存储**：
   
   - 保存推荐方案到数据库
   - 生成推荐单号
   - 返回推荐结果给前端

**输出格式**（JSON）：

```json
{
  "recommendation_no": "AIRD+ZDT+20241219143025+00001",
  "options": [
    {
      "option_index": 1,
      "product_type": "flight",
      "product_data": {...},
      "keywords": ["直飞优先", "最短时间"],
      "reason": "推荐原因说明",
      "price": 1200.00,
      "score": 95.5,
      "policy_compliance": true
    }
  ]
}
```

#### 5.3.2 差旅产品API集成

**开发阶段**：

- 使用Mock数据模拟产品API响应
- Mock数据需包含完整的产品信息（价格、时间、供应商等）
- Mock数据格式需与真实API格式一致，便于后续切换

**生产环境**：

- 集成第三方差旅供应商API（如携程、去哪儿、飞猪等）
- 或自建产品数据库，定期同步供应商数据
- 需要定义统一的产品数据模型

**产品数据模型**（示例）：

- 机票：航班号、航空公司、出发/到达时间、价格、舱位、机型等
- 酒店：酒店名称、星级、位置、价格、设施、评分等
- 火车票：车次、出发/到达时间、座位类型、价格等
- 用车：车型、服务类型、价格、服务商等

---

## 6. 非功能性需求

### 6.1 性能要求

- 页面加载时间 < 2秒
- AI推荐生成时间 < 10秒
- 支持并发用户数 > 1000

### 6.2 安全要求

- 用户数据加密存储
- API接口需要认证
- 敏感信息脱敏显示

### 6.3 可用性要求

- 系统可用性 > 99.5%
- 数据备份机制
- 错误日志记录

### 6.4 用户体验要求

- 响应式设计，支持PC和移动端
- 友好的错误提示
- 加载状态提示
- 操作反馈及时

### 6.5 错误处理机制

**错误分类**：

- **网络错误**：API调用失败、超时等
- **业务错误**：数据验证失败、业务规则不满足等
- **系统错误**：服务器错误、数据库错误等
- **AI错误**：AI推荐失败、对话服务异常等

**错误处理策略**：

- **网络错误**：显示友好提示，提供重试按钮
- **业务错误**：显示具体错误原因，引导用户修正
- **系统错误**：显示通用错误提示，记录错误日志
- **AI推荐失败**：提供降级方案（如返回经典预订入口）

**错误码定义**：

- 1000-1999：网络相关错误
- 2000-2999：业务逻辑错误
- 3000-3999：数据验证错误
- 4000-4999：权限相关错误
- 5000-5999：系统内部错误

---

## 7. 未来扩展方向

### 7.1 AI能力增强

- 更智能的推荐算法
- 个性化偏好学习
- 多语言支持
- 语音交互

### 7.2 功能扩展

- 差旅费用报销
- 差旅数据分析
- 差旅政策智能匹配
- 多供应商比价
- 差旅预算管理

### 7.3 集成扩展

- 企业OA系统集成
- 财务系统集成
- 第三方差旅供应商API集成

---

## 8. 开发优先级

### Phase 1 (MVP - 核心功能)

1. 用户认证与个人中心
2. 出差申请管理（提交、查看、审批）
3. 经典预订基础功能
4. AI推荐方案基础功能（基于申请单）

### Phase 2 (增强功能)

1. 智能对话预订
2. 重新推荐功能
3. 一键预订功能
4. 完整的审批流程

### Phase 3 (优化与扩展)

1. AI推荐算法优化
2. 用户体验优化
3. 数据分析功能
4. 移动端适配

---

## 9. 验收标准

### 9.1 功能验收

- 所有功能模块按需求文档实现
- 单号生成规则正确
- 数据存储完整
- 审批流程正常

### 9.2 性能验收

- 满足性能要求指标
- 无明显卡顿和错误

### 9.3 用户体验验收

- 界面友好，操作流畅
- 错误提示清晰
- 响应式设计正常

---

## 10. 附录

### 10.1 术语表

- **出差申请单**：用户提交的出差需求申请
- **预订单**：用户确认预订后生成的订单
- **AI推荐方案**：AI根据需求自动生成的差旅方案
- **经典预订**：传统的搜索-选择-预订流程
- **智能对话**：AI对话式预订功能

### 10.2 参考文档

- 设计思路文档：`YQFAIBTRIP设计思路.md`
- 页面结构图：`网站页面结构图.md`
