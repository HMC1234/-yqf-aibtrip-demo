# Supabase 数据库执行指南

## 📋 准备工作

### 需要的配置信息

根据设计思路文档，您已经提供了：
- ✅ Anon Key
- ✅ Service Role Key

**还需要确认的信息**：
1. **Supabase Project URL**：
   - 从key中提取的ref：`ienbmjucvvvdwfwcpejy`
   - 请确认完整URL是否为：`https://ienbmjucvvvdwfwcpejy.supabase.co`

2. **数据库连接方式**：
   - 方式1：通过Supabase Dashboard的SQL Editor执行
   - 方式2：通过Supabase CLI执行
   - 方式3：通过PostgreSQL客户端直接连接

---

## 🚀 执行步骤

### 方式1：通过Supabase Dashboard执行（推荐）

1. **登录Supabase Dashboard**
   - 访问：https://supabase.com/dashboard
   - 登录您的账户

2. **选择项目**
   - 选择项目：`ienbmjucvvvdwfwcpejy`（或您的项目名称）

3. **打开SQL Editor**
   - 在左侧菜单选择 "SQL Editor"
   - 点击 "New query"

4. **执行迁移脚本**
   - 打开 `database_migration.sql` 文件
   - 复制全部内容
   - 粘贴到SQL Editor中
   - 点击 "Run" 执行

5. **验证执行结果**
   - 检查是否有错误
   - 在 "Table Editor" 中查看创建的表
   - 在 "Database" > "Functions" 中查看创建的函数

### 方式2：通过Supabase CLI执行

1. **安装Supabase CLI**（如果未安装）
   ```bash
   npm install -g supabase
   ```

2. **登录Supabase**
   ```bash
   supabase login
   ```

3. **链接项目**
   ```bash
   supabase link --project-ref ienbmjucvvvdwfwcpejy
   ```

4. **执行迁移**
   ```bash
   supabase db push
   ```
   或者直接执行SQL文件：
   ```bash
   psql -h db.ienbmjucvvvdwfwcpejy.supabase.co -U postgres -d postgres -f database_migration.sql
   ```

### 方式3：通过PostgreSQL客户端执行

1. **获取数据库连接信息**
   - 在Supabase Dashboard中：Settings > Database
   - 获取连接字符串或单独的参数

2. **使用psql连接**
   ```bash
   psql "postgresql://postgres:[YOUR-PASSWORD]@db.ienbmjucvvvdwfwcpejy.supabase.co:5432/postgres"
   ```

3. **执行SQL文件**
   ```sql
   \i database_migration.sql
   ```

---

## ✅ 执行后验证

### 1. 检查表是否创建成功

在Supabase Dashboard的 "Table Editor" 中，应该能看到以下14张表：

**用户相关（4张）**：
- ✅ companies
- ✅ departments
- ✅ cost_centers
- ✅ users

**业务相关（5张）**：
- ✅ travel_requests
- ✅ approval_records
- ✅ orders
- ✅ search_records
- ✅ travel_policies

**AI相关（4张）**：
- ✅ ai_recommendations
- ✅ recommendation_details
- ✅ chat_messages
- ✅ keywords

**系统相关（1张）**：
- ✅ sequence_numbers

### 2. 检查函数是否创建成功

在 "Database" > "Functions" 中，应该能看到：
- ✅ update_updated_at_column()
- ✅ generate_travel_request_no()
- ✅ generate_order_no()
- ✅ generate_recommendation_no()

### 3. 检查触发器是否创建成功

在 "Database" > "Triggers" 中，应该能看到所有表的 `update_*_updated_at` 触发器。

### 4. 检查RLS策略是否创建成功

在 "Authentication" > "Policies" 中，应该能看到：
- ✅ Users can view own data
- ✅ Users can view own travel requests
- ✅ Users can view own orders
- ✅ Users can view own search records
- ✅ Users can insert own search records
- ✅ Users can delete own search records
- ✅ Users can view own recommendations

### 5. 检查初始化数据

在 "Table Editor" 中检查：
- ✅ companies 表中有1条测试公司记录
- ✅ departments 表中有1条测试部门记录
- ✅ cost_centers 表中有1条测试成本中心记录
- ✅ keywords 表中有26条关键字记录

---

## 🔧 创建测试用户

### 通过Supabase Dashboard创建

1. **打开Authentication**
   - 在左侧菜单选择 "Authentication" > "Users"

2. **创建新用户**
   - 点击 "Add user" > "Create new user"
   - Email: `test@example.com`（或您指定的邮箱）
   - Password: `123456`
   - 点击 "Create user"

3. **获取用户ID**
   - 复制创建的用户ID（UUID格式）

4. **在users表中插入用户信息**
   ```sql
   INSERT INTO users (
       id,
       email,
       username,
       full_name,
       company_id,
       department_id,
       cost_center_id,
       role
   ) VALUES (
       '[复制的用户ID]',
       'test@example.com',
       'test',
       '测试用户',
       '00000000-0000-0000-0000-000000000001',
       '00000000-0000-0000-0000-000000000002',
       '00000000-0000-0000-0000-000000000003',
       'employee'
   );
   ```

---

## 📝 注意事项

1. **执行顺序**：
   - 必须先创建基础表（companies, departments, cost_centers）
   - 再创建依赖表（users, travel_requests等）
   - 最后创建函数、触发器、RLS策略

2. **错误处理**：
   - 如果遇到外键约束错误，检查表创建顺序
   - 如果遇到函数已存在错误，可以先删除再创建
   - 如果遇到RLS策略冲突，先删除旧策略

3. **数据备份**：
   - 执行前建议备份现有数据（如果有）
   - 在Supabase Dashboard中：Settings > Database > Backups

4. **权限问题**：
   - 确保使用Service Role Key或具有足够权限的账户
   - 某些操作可能需要管理员权限

---

## 🆘 常见问题

### Q1: 执行时提示"relation already exists"
**A**: 表已存在，可以：
- 删除现有表后重新执行
- 或使用 `CREATE TABLE IF NOT EXISTS`（脚本中已包含）

### Q2: 执行时提示"function already exists"
**A**: 函数已存在，可以：
- 先删除函数：`DROP FUNCTION IF EXISTS function_name;`
- 或脚本中的 `CREATE OR REPLACE FUNCTION` 会自动替换

### Q3: RLS策略创建失败
**A**: 检查：
- 表是否已启用RLS
- 策略名称是否冲突
- 使用 `DROP POLICY IF EXISTS` 先删除旧策略

### Q4: 外键约束错误
**A**: 检查：
- 依赖的表是否已创建
- 外键引用的ID是否存在
- 执行顺序是否正确

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. 错误信息截图
2. 执行的SQL语句
3. Supabase项目信息（不包含敏感密钥）

---

**执行状态**：待执行  
**创建日期**：2024-12-19

