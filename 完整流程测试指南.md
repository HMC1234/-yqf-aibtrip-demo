# 完整流程测试指南

## 🎯 测试目标

完成从**提交申请**到**生成订单**的完整流程测试。

---

## 📋 完整流程

### 流程1：经典预订流程

1. **提交出差申请**
   - 登录系统
   - 提交出差申请
   - 等待审批（或手动更新状态为approved）

2. **经典预订**
   - 在申请单详情页点击"经典预订"
   - 自动填充搜索条件
   - 搜索产品
   - 选择产品
   - 确认订单
   - 生成订单（BK+TR+...）

3. **查看订单**
   - 在"我的订单"中查看订单
   - 查看订单详情

### 流程2：AI推荐预订流程

1. **提交出差申请**
   - 登录系统
   - 提交出差申请
   - 等待审批（或手动更新状态为approved）

2. **AI推荐生成**
   - 在申请单详情页点击"AI预订"
   - 观看AI推荐生成过程
   - 查看推荐方案列表

3. **一键预订**
   - 在推荐方案卡片点击"一键预订"
   - 或进入方案详情页点击"一键预订"
   - 确认订单信息
   - 生成订单（BK+AI+...）

4. **查看订单**
   - 在"我的订单"中查看订单
   - 查看订单详情

---

## ✅ 测试检查清单

### 经典预订流程
- [ ] 能够从申请单跳转到经典预订页面
- [ ] 搜索条件自动填充正确
- [ ] 能够搜索产品
- [ ] 能够选择产品
- [ ] 能够确认订单
- [ ] 订单号格式正确（BK+TR+...）
- [ ] 搜索记录已保存
- [ ] 订单已创建

### AI推荐预订流程
- [ ] 能够从申请单跳转到AI预订
- [ ] AI推荐生成过程正常
- [ ] 推荐方案列表显示正常
- [ ] 能够点击"一键预订"
- [ ] 订单确认页面信息正确
- [ ] 订单号格式正确（BK+AI+...）
- [ ] 订单已创建并关联推荐方案

### 订单管理
- [ ] 能够查看订单列表
- [ ] 能够按状态筛选订单
- [ ] 能够查看订单详情
- [ ] 订单信息完整

---

## 🔧 需要执行的SQL

### 1. 修复RLS策略（必须执行）

在Supabase SQL Editor中执行 `修复RLS策略.sql`

这将允许：
- 用户插入自己的订单
- 用户插入搜索记录
- 用户插入AI推荐方案

### 2. 更新申请单状态（测试用）

```sql
-- 将所有申请单更新为已审批
UPDATE travel_requests 
SET status = 'approved' 
WHERE status = 'pending';
```

---

## 🎯 测试步骤

### 步骤1：准备数据

1. 确保已执行 `修复RLS策略.sql`
2. 提交一个出差申请
3. 将申请单状态更新为 `approved`

### 步骤2：测试经典预订

1. 进入申请单详情页
2. 点击"经典预订"
3. 确认搜索条件已自动填充
4. 点击"搜索"
5. 选择一个产品
6. 点击"确认预订"
7. 填写联系信息
8. 点击"确认下单"
9. 查看订单列表

### 步骤3：测试AI推荐预订

1. 进入申请单详情页
2. 点击"AI预订"
3. 等待AI推荐生成
4. 查看推荐方案列表
5. 点击"一键预订"
6. 确认订单信息
7. 填写联系信息
8. 点击"确认下单"
9. 查看订单列表

---

## 📝 验证要点

### 订单号验证

- **经典预订订单**：应该以 `BK+TR+` 开头
- **AI推荐订单**：应该以 `BK+AI+` 开头

### 数据关联验证

- 订单应该关联用户
- 订单应该关联公司、部门、成本中心
- AI推荐订单应该关联推荐方案
- 从申请单跳转的订单应该关联申请单

### 搜索记录验证

- 经典预订搜索应该记录到 `search_records` 表
- 搜索记录应该关联用户
- 如果从申请单跳转，应该关联申请单

---

## 🐛 常见问题

### Q1: 创建订单时403错误
**A**: 确保已执行 `修复RLS策略.sql`

### Q2: 搜索记录保存失败
**A**: 检查RLS策略是否正确创建

### Q3: 订单号生成失败
**A**: 检查 `generate_order_no` 函数是否正常工作

---

**开始测试完整流程！** 🚀






